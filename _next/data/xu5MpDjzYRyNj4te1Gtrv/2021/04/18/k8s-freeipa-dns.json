{"pageProps":{"post":{"id":2,"assetRoot":"2021/04/17/0","thumbnail":null,"title":"How to set up Dynamic DNS on FreeIPA for your Kubernetes Cluster","description":null,"slug":"k8s-freeipa-dns","date":"2021-04-18T20:35:45.000Z","content":"<p>I have a <a href=\"https://www.freeipa.org/page/Main_Page\">FreeIPA</a> server that serves DNS on my home network. I wanted to automatically configure it with my Kubernetes ingresses using <a href=\"https://github.com/kubernetes-sigs/external-dns\">ExternalDNS</a>. There doesn’t seem to be much documentation for this specific setup, so I thought to put together this guide!</p>\n<h2 id=\"requirements\">Requirements</h2>\n<p>This guide will assume that you have the following set up already:</p>\n<ul>\n<li>A Kubernetes cluster running on your network</li>\n<li>A FreeIPA server (let’s say <code>ipa0.p.astrid.tech</code>) serving DNS for a certain zone you want as the domain suffixes (call it <code>s.astrid.tech</code>)</li>\n<li>An app (or apps) on the Kubernetes cluster exposed on an Ingress (we’ll assume it’s <code>firefly.s.astrid.tech</code>)</li>\n</ul>\n<p>In addition, I used the following guides to assemble this guide:</p>\n<ul>\n<li><a href=\"https://www.freeipa.org/page/Howto/ISC_DHCPd_and_Dynamic_DNS_update\">FreeIPA - Howto/ISC DHCPd and Dynamic DNS update</a></li>\n<li><a href=\"https://www.freeipa.org/page/Howto/DNS_updates_and_zone_transfers_with_TSIG\">FreeIPA - Howto/DNS updates and zone transfers with TSIG</a></li>\n<li><a href=\"https://flylib.com/books/en/2.684.1/allowing_dynamic_updates.html\">Flylib.com - Allowing Dynamic Updates</a></li>\n<li><a href=\"https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/rfc2136.md\">ExternalDNS - Configuring RFC2136 provider</a></li>\n<li><a href=\"https://github.com/bitnami/charts/tree/master/bitnami/external-dns\">bitnami/external-dns Helm chart</a></li>\n</ul>\n<h2 id=\"1-generate-a-tsig-key-and-register-it\">1. Generate a TSIG key and register it</h2>\n<p>We will need to generate a TSIG key first.</p>\n<p>Choose a name for your key. I called mine <code>k8s</code> but we’ll call it <code>keyname</code>. Then on your FreeIPA server, execute</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\">$ dnssec-keygen -a HMAC-SHA512 -b <span class=\"token number\">512</span> -n HOST keyname\n</code></pre></div>\n<p>and you will get 2 files in your working directory that are probably called something like <code>Kkeyname.+165+44840.key</code> and <code>Kkeyname.+165+44840.private</code>. Open up the <code>.private</code> one:</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">$ cat Kkeyname.+165+44840.private\nPrivate-key-format: v1.3\nAlgorithm: 165 (HMAC_SHA512)\nKey: zeOLcYcv/95yZX1KSLDreZyMtAsy5Ci5xwC9gW7XAgtOnOTIJpyr03CNDA8sUxfrkhb6Hjs90d3zRGm2g0XDaQ==\nBits: AAA=\nCreated: 20210418040622\nPublish: 20210418040622\nActivate: 20210418040622</code></pre></div>\n<p>and copy the part after <code>Key:</code>.</p>\n<p>Finally, add the following to your <code>/etc/named.conf</code>, but substitute the key for your key:</p>\n<div class=\"remark-highlight\"><pre class=\"language-conf\"><code class=\"language-conf\">key &#x26;quot;keyname&#x26;quot; {\n       algorithm hmac-sha512;\n       secret &#x26;quot;zeOLcYcv/95yZX1KSLDreZyMtAsy5Ci5xwC9gW7XAgtOnOTIJpyr03CNDA8sUxfrkhb6Hjs90d3zRGm2g0XDaQ==&#x26;quot;;\n};</code></pre></div>\n<p>Repeat this for every FreeIPA server you have, and we can move onto the next step.</p>\n<h2 id=\"2-enable-ddns-on-your-freeipa-server\">2. Enable DDNS on your FreeIPA server</h2>\n<p>This step can be done via UI or CLI, but I did it via UI.</p>\n<p>First, navigate to your DNS zone’s settings page.</p>\n<img src=\"/_/2021/04/17/0/dns-settings.png\" alt=\"How the top of your UI should look\">\n<p>Scroll down to where it says “Dynamic update” and set that to True. Additionally, add the following line<sup id=\"fnref-guide-dev-1\"><a href=\"#fn-guide-dev-1\" class=\"footnote-ref\">guide-dev-1</a></sup> to “BIND update policy,” replacing <code>keyname</code> with your key and <code>s.astrid.tech</code> with your zone:</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">grant keyname subdomain s.astrid.tech ANY;</code></pre></div>\n<p>Now, your UI should look something like this:</p>\n<img src=\"/_/2021/04/17/0/ddns-and-bind-update-policy.png\" alt=\"How your UI should look after making these changes\">\n<p>Save your changes, and anyone with that secret key can add anything to that subdomain.</p>\n<h2 id=\"3-install-externaldns-on-your-kubernetes-cluster\">3. Install ExternalDNS on your Kubernetes cluster</h2>\n<p><a href=\"https://github.com/kubernetes-sigs/external-dns\">ExternalDNS</a> is an addon for Kubernetes that has functionality to provide DNS updates over RFC2136. I installed the <a href=\"https://github.com/bitnami/charts/tree/master/bitnami/external-dns\">bitnami/external-dns Helm chart</a> using the following <a href=\"https://github.com/roboll/helmfile\">Helmfile</a>:</p>\n<div class=\"remark-highlight\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">repositories</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> bitnami\n    <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//charts.bitnami.com/bitnami\n<span class=\"token key atrule\">releases</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> freeipa<span class=\"token punctuation\">-</span>dns<span class=\"token punctuation\">-</span>sync\n    <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> external<span class=\"token punctuation\">-</span>dns\n    <span class=\"token key atrule\">chart</span><span class=\"token punctuation\">:</span> bitnami/external<span class=\"token punctuation\">-</span>dns\n    <span class=\"token key atrule\">installed</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span> rfc2136\n        <span class=\"token key atrule\">logFormat</span><span class=\"token punctuation\">:</span> json\n        <span class=\"token key atrule\">domainFilters</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> s.astrid.tech <span class=\"token comment\"># only handle DDNS for *.s.astrid.tech domains</span>\n        <span class=\"token key atrule\">rfc2136</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> ipa0.p.astrid.tech <span class=\"token comment\"># replace with your host</span>\n          <span class=\"token key atrule\">zone</span><span class=\"token punctuation\">:</span> s.astrid.tech <span class=\"token comment\"># replace with your zone</span>\n          <span class=\"token key atrule\">tsigKeyname</span><span class=\"token punctuation\">:</span> keyname <span class=\"token comment\"># replace with your keyname</span>\n          <span class=\"token key atrule\">tsigSecretAlg</span><span class=\"token punctuation\">:</span> hmac<span class=\"token punctuation\">-</span>sha512\n          <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> freeipa<span class=\"token punctuation\">-</span>rfc2136\n</code></pre></div>\n<p>After deploying this with <code>helmfile apply</code>, I then installed the following secret:</p>\n<div class=\"remark-highlight\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Secret\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> freeipa<span class=\"token punctuation\">-</span>rfc2136\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> external<span class=\"token punctuation\">-</span>dns\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Opaque\n<span class=\"token key atrule\">stringData</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># replace with your secret</span>\n  <span class=\"token key atrule\">rfc2136_tsig_secret</span><span class=\"token punctuation\">:</span> zeOLcYcv/95yZX1KSLDreZyMtAsy5Ci5xwC9gW7XAgtOnOTIJpyr03CNDA8sUxfrkhb6Hjs90d3zRGm2g0XDaQ==\n</code></pre></div>\n<p>And that’s it! You should soon see DNS records show up in FreeIPA automatically.</p>\n<img src=\"/_/2021/04/17/0/dns-complete.png\" alt=\"FreeIPA DNS, but with automatically updated DNS settings\">\n<p>For debugging, you may want to check external DNS’s logs using <code>kubectl logs [podname]</code>.</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-guide-dev-1\">Note that this is a deviation from <a href=\"https://www.freeipa.org/page/Howto/DNS_updates_and_zone_transfers_with_TSIG\">this guide</a>, where it says to write <code>grant keyname name s.astrid.tech ANY;</code>. <code>name</code> only allows you to change <code>s.astrid.tech</code>, while <code>subdomain</code> allows you to change every domain like <code>*.s.astrid.tech</code>, as described <a href=\"https://flylib.com/books/en/2.684.1/allowing_dynamic_updates.html\">here</a>.<a href=\"#fnref-guide-dev-1\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","tags":["devops","dns","freeipa","kubernetes"]}},"__N_SSG":true}