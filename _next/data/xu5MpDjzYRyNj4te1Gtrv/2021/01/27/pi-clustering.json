{"pageProps":{"post":{"id":7,"assetRoot":"2021/01/27/pi-clustering","thumbnail":null,"title":"Adding Pi's to a cluster","description":"Zerg-rushing server workloads","slug":"pi-clustering","date":"2021-01-27T06:29:00.000Z","content":"<p>Look at all of these single-board computers lying around. What are they even doing? <em>Literally nothing.</em> Let’s put them to good use.</p>\n<img src=\"/_/2021/01/27/pi-clustering/raw-pis.jpeg\" alt=\"Two Pi 3&#x27;s, one Pi 2, and one Orange Pi one\">\n<h2 id=\"raspberry-pi-sd-cards\">Raspberry Pi SD Cards</h2>\n<p>I got the latest <a href=\"https://www.raspberrypi.org/software/operating-systems/\">Raspbian Buster Lite image</a> and extracted the image. To make things easier on myself, I decided to enable SSH-on-first-boot for the image so that I can just brainlessly <code>dd</code> everything onto SD cards.</p>\n<p>First, I executed</p>\n<div class=\"remark-highlight\"><pre class=\"language-zsh\"><code class=\"language-zsh\">losetup -P /dev/loop99 2021-01-11-raspios-buster-armhf-lite.img</code></pre></div>\n<p>to mount the image on a loop device. 99 was chosen because snapd makes a goddamn million loop devices.</p>\n<p><code>lsblk</code> returned the following:</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">NAME                  MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT\nloop0                   7:0    0 818.2M  1 loop /snap/android-studio/98\nloop1                   7:1    0 373.8M  1 loop /snap/anbox/186\n...\nloop47                  7:47   0 135.7M  1 loop /snap/chromium/1466\nloop99                  7:99   0   1.8G  0 loop\n├─loop99p1            259:7    0   256M  0 part\n└─loop99p2            259:8    0   1.5G  0 part\n...</code></pre></div>\n<p>Perfect! Once that was done, it was a simple</p>\n<div class=\"remark-highlight\"><pre class=\"language-zsh\"><code class=\"language-zsh\">mkdir -p /tmp/bootsd\nmount /dev/loop99p1 /tmp/bootsd\ntouch /tmp/bootsd/ssh</code></pre></div>\n<p>and the SD card image was ready. To clean everything up:</p>\n<div class=\"remark-highlight\"><pre class=\"language-zsh\"><code class=\"language-zsh\">umount /tmp/bootsd\nlosetup -d /dev/loop99</code></pre></div>\n<p>Finally, I plugged in the SD cards one by one and flashed them with</p>\n<div class=\"remark-highlight\"><pre class=\"language-zsh\"><code class=\"language-zsh\">dd bs=64M of=/dev/sdb if=2021-01-11-raspios-buster-armhf-lite.img</code></pre></div>\n<p>As soon as I booted each of them, and they were assigned DHCP addresses, I SSH’ed into them to change the password because security.</p>\n<h2 id=\"orange-pi-sd-card\">Orange Pi SD Card</h2>\n<p>The Orange Pi One was set up in a similar fashion, except that I got the Armbian image from <a href=\"http://www.orangepi.org/downloadresources/\">the Orange Pi website</a> (scroll like, really far for the OPi One).</p>\n<h2 id=\"getting-k3s-on-them\">Getting k3s on them</h2>\n<p>I used <code>ssh-copy-id</code> to install my public key on all of the devices for passwordless login, and then used <a href=\"https://github.com/alexellis/k3sup\">k3sup</a> for quickly installing k3s on them:</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">k3sup join --sudo --server-user rancher --user pi --server-ip &#x26;lt;my server&#x26;#39;s address&#x26;gt; --ip &#x26;lt;the pi&#x26;#39;s address&#x26;gt;</code></pre></div>\n<p>Forking multiple instances of k3sup made life easier.</p>\n<p>So now, I have <strong>7 whole nodes on my kubernetes cluster!</strong> Fear my power!</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">$ kubectl get node\nNAME         STATUS     ROLES    AGE     VERSION\nzerg-1       NotReady   &#x26;lt;none&#x26;gt;   2d1h    v1.19.7+k3s1  # rpi\nk3os-28502   Ready      master   6d2h    v1.19.5+k3s2\norangepi     Ready      &#x26;lt;none&#x26;gt;   4d10h   v1.19.7+k3s1  # opi\nzerg2        Ready      &#x26;lt;none&#x26;gt;   2d1h    v1.19.7+k3s1  # rpi\nzerg3        Ready      &#x26;lt;none&#x26;gt;   2d1h    v1.19.7+k3s1  # rpi\nk3os-10009   Ready      &#x26;lt;none&#x26;gt;   5d23h   v1.19.5+k3s2\nk3os-3502    Ready      &#x26;lt;none&#x26;gt;   3h13m   v1.19.5+k3s2</code></pre></div>\n<p>Please ignore the inconsistent dashing scheme on the zerg* series.</p>\n<img src=\"/_/2021/01/27/pi-clustering/nodezzz.jpeg\" alt=\"Look at these SBC&#x27;s!\">\n<p>Now what are they running? …unfortunately, still, absolutely nothing. Once again, my k3s cluster is a solution looking for a problem.</p>\n<p>In my next post, I’ll talk about my Grafana + Prometheus setup.</p>","tags":["/projects/plebscale/","devops","kubernetes","raspberry-pi"]}},"__N_SSG":true}