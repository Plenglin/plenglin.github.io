{"pageProps":{"post":{"id":5,"assetRoot":"2021/02/13/terraform-mysql-k8s","thumbnail":null,"title":"Declaratively Provision Databases and Submit Credentials to Kubernetes using Terraform","description":"DATABASES! I didn't say it, I DECLARED it!","slug":"terraform-mysql-k8s","date":"2021-02-13T20:10:50.000Z","content":"<p>Firefly III is a budget management app that I’m trying to self-host. Being a budget management app, it would hold every single monetary transaction I make, which is obviously somewhat sensitive. As such, I’m running it on my local cluster instead of on a public cloud instance that also hosts my website backend.</p>\n<h2 id=\"provisioning-the-server-manually\">Provisioning the server manually</h2>\n<p>Firefly uses MySQL as its database backend, so I’ve spun up an LXC container built from TurnKeyLinux’s excellent MySQL container image through Proxmox.</p>\n<img src=\"/_/2021/02/13/terraform-mysql-k8s/turnkey-mysql.png\" alt=\"The downloadable TurnKeyLinux MySQL LXC image\">\n<img src=\"/_/2021/02/13/terraform-mysql-k8s/proxmox-container.png\" alt=\"The LXC container running.\">\n<p>Unfortunately, I didn’t automate this step; I just manually provisioned it through the web UI like a pleb. However, I will try to automate it using Terraform for my Postgres database, possibly in a later blog post.</p>\n<h2 id=\"provisioning-the-database-automatically\">Provisioning the database automatically</h2>\n<p>However, once I had that out of the way, I wrote a short Terraform configuration that:</p>\n<ol>\n<li>Provisions a MySQL database</li>\n<li>Provisions a user with an automatically-generated password</li>\n<li>Securely creates a secret in Kubernetes to be used in Firefly</li>\n</ol>\n<h3 id=\"declaring-plugins-and-providers\">Declaring plugins and providers</h3>\n<p>First, we declare the plugins we use.</p>\n<div class=\"remark-highlight\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">terraform</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">required_version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\">= 0.13.0\"</span>\n\n  <span class=\"token keyword\">required_providers</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">random</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">source</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"hashicorp/random\"</span>\n      <span class=\"token property\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\">= 2.2.0\"</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token property\">mysql</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">source</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"terraform-providers/mysql\"</span>\n      <span class=\"token property\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\">= 1.5\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Next, we declare some variables for our MySQL admin parameters.</p>\n<div class=\"remark-highlight\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"mysql_host\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"MySQL server host.\"</span>\n  <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"mysql_port\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"MySQL server port.\"</span>\n  <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"mysql_admin_user\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"MySQL server administrator's username.\"</span>\n  <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"mysql_admin_password\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"MySQL server administrator's password.\"</span>\n  <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n  <span class=\"token property\">sensitive</span>   <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>We can import them in an <code>.env</code> file that looks like this.</p>\n<div class=\"remark-highlight\"><pre class=\"language-sh\"><code class=\"language-sh\">export TF_VAR_mysql_host=...\nexport TF_VAR_mysql_port=...\nexport TF_VAR_mysql_admin_user=...\nexport TF_VAR_mysql_admin_password=...</code></pre></div>\n<p>Combining all of those variables together, we declare the following MySQL provider:</p>\n<div class=\"remark-highlight\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">provider<span class=\"token type variable\"> \"mysql\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">endpoint</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">mysql_host</span><span class=\"token punctuation\">}</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">mysql_port</span><span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">username</span> <span class=\"token punctuation\">=</span> var.mysql_admin_user\n  <span class=\"token property\">password</span> <span class=\"token punctuation\">=</span> var.mysql_admin_password\n  <span class=\"token property\">tls</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"skip-verify\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Additionally, we declare our Kubernetes provider to allow us to directly insert our passwords into the cluster as a Secret.</p>\n<div class=\"remark-highlight\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">provider<span class=\"token type variable\"> \"kubernetes\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">config_path</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"~/.kube/config\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h3 id=\"declaring-a-database-and-user\">Declaring a Database and User</h3>\n<p>Declaring a database is as simple as</p>\n<div class=\"remark-highlight\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"mysql_database\"</span></span> <span class=\"token string\">\"firefly\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"fireflyiii\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>To create our user, however, we need to first generate a password. This creates a 16-char password.</p>\n<div class=\"remark-highlight\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"random_password\"</span></span> <span class=\"token string\">\"firefly_password\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">length</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">16</span>\n  <span class=\"token property\">special</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token property\">override_special</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"_%@\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>With our password, we can create the user.</p>\n<div class=\"remark-highlight\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"mysql_user\"</span></span> <span class=\"token string\">\"firefly\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">user</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"fireflyop\"</span>\n  <span class=\"token property\">plaintext_password</span>  <span class=\"token punctuation\">=</span> random_password.firefly_password.result\n  <span class=\"token property\">host</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"192.168.1.%\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>The variable <code>random_password.firefly_password.result</code> is in <code>&#x3C;provider>.&#x3C;resource name>.&#x3C;field name></code> form.</p>\n<p>In order to let our user actually do things, we need to grant them all the privileges on the <code>firefly</code> database.</p>\n<p><strong>Warning:</strong> To be honest, I don’t know how to do this the right way. I thought it could do a <code>GRANT ALL ON ...</code> with the following segment of code:</p>\n<div class=\"remark-highlight\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"mysql_grant\"</span></span> <span class=\"token string\">\"firefly\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">user</span> <span class=\"token punctuation\">=</span> mysql_user.firefly.user\n  <span class=\"token property\">host</span> <span class=\"token punctuation\">=</span> mysql_user.firefly.host\n  <span class=\"token property\">database</span> <span class=\"token punctuation\">=</span> mysql_database.firefly.name\n  <span class=\"token property\">privileges</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"ALL\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>but this doesn’t seem to work. I ended up running the Terraform script to provision almost all of the resources, then granting the privileges manually.</p>\n<h3 id=\"giving-kubernetes-the-passwords\">Giving Kubernetes the Passwords</h3>\n<p>There is one final step that is specific to Firefly III that we must do. Firefly III encrypts its database with a 32-character key, so we need to generate that. I could have done this outside of Terraform, but I thought it would be more convenient to do it inside.</p>\n<div class=\"remark-highlight\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"random_password\"</span></span> <span class=\"token string\">\"firefly_key\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">length</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">32</span>\n  <span class=\"token property\">special</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token property\">override_special</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"_%@{}~`[]()\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Finally, we can submit all of our secrets to Kubernetes! We do this by taking all of our variables from above and combining it together.</p>\n<div class=\"remark-highlight\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"kubernetes_secret\"</span></span> <span class=\"token string\">\"firefly\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Opaque\"</span>\n\n  <span class=\"token keyword\">metadata</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"firefly-db\"</span>\n    <span class=\"token property\">namespace</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"firefly-iii\"</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token property\">data</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"APP_KEY\"</span> <span class=\"token punctuation\">=</span> random_password.firefly_key.result\n    <span class=\"token property\">\"DB_USERNAME\"</span> <span class=\"token punctuation\">=</span> mysql_user.firefly.user\n    <span class=\"token property\">\"DB_PASSWORD\"</span> <span class=\"token punctuation\">=</span> random_password.firefly_password.result\n    <span class=\"token property\">\"DB_HOST\"</span> <span class=\"token punctuation\">=</span> var.mysql_host\n    <span class=\"token property\">\"DB_PORT\"</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">3306</span>\n    <span class=\"token property\">\"DB_DATABASE\"</span> <span class=\"token punctuation\">=</span> mysql_database.firefly.name\n    <span class=\"token property\">\"DB_CONNECTION\"</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"mysql\"</span>\n    <span class=\"token property\">\"MYSQL_USE_SSL\"</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"true\"</span>\n    <span class=\"token property\">\"MYSQL_SSL_VERIFY_SERVER_CERT\"</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"false\"</span>\n    <span class=\"token property\">\"MYSQL_SSL_CAPATH\"</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"/etc/ssl/certs/\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>This creates <code>secret/firefly-db</code> under namespace <code>firefly-iii</code> with all of the parameters that we want.</p>\n<h3 id=\"putting-it-all-together\">Putting it all together</h3>\n<p>We have a full configuration file now!</p>\n<div class=\"remark-highlight\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">terraform</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">required_version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\">= 0.13.0\"</span>\n\n  <span class=\"token keyword\">required_providers</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">random</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">source</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"hashicorp/random\"</span>\n      <span class=\"token property\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\">= 2.2.0\"</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token property\">mysql</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">source</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"terraform-providers/mysql\"</span>\n      <span class=\"token property\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\">= 1.5\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"mysql_host\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"MySQL server host.\"</span>\n  <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"mysql_port\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"MySQL server port.\"</span>\n  <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"mysql_admin_user\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"MySQL server administrator's username.\"</span>\n  <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"mysql_admin_password\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"MySQL server administrator's password.\"</span>\n  <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n  <span class=\"token property\">sensitive</span>   <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">provider<span class=\"token type variable\"> \"mysql\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">endpoint</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">mysql_host</span><span class=\"token punctuation\">}</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">mysql_port</span><span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">username</span> <span class=\"token punctuation\">=</span> var.mysql_admin_user\n  <span class=\"token property\">password</span> <span class=\"token punctuation\">=</span> var.mysql_admin_password\n  <span class=\"token property\">tls</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"skip-verify\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"mysql_database\"</span></span> <span class=\"token string\">\"firefly\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"fireflyiii\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"random_password\"</span></span> <span class=\"token string\">\"firefly_password\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">length</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">16</span>\n  <span class=\"token property\">special</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token property\">override_special</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"_%@\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"mysql_user\"</span></span> <span class=\"token string\">\"firefly\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">user</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"fireflyop\"</span>\n  <span class=\"token property\">plaintext_password</span>  <span class=\"token punctuation\">=</span> random_password.firefly_password.result\n  <span class=\"token property\">host</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"192.168.1.%\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"mysql_grant\"</span></span> <span class=\"token string\">\"firefly\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">user</span> <span class=\"token punctuation\">=</span> mysql_user.firefly.user\n  <span class=\"token property\">host</span> <span class=\"token punctuation\">=</span> mysql_user.firefly.host\n  <span class=\"token property\">database</span> <span class=\"token punctuation\">=</span> mysql_database.firefly.name\n  <span class=\"token property\">privileges</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"ALL\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">provider<span class=\"token type variable\"> \"kubernetes\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">config_path</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"~/.kube/config\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"random_password\"</span></span> <span class=\"token string\">\"firefly_key\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">length</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">32</span>\n  <span class=\"token property\">special</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token property\">override_special</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"_%@{}~`[]()\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"kubernetes_secret\"</span></span> <span class=\"token string\">\"firefly\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Opaque\"</span>\n\n  <span class=\"token keyword\">metadata</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"firefly-db\"</span>\n    <span class=\"token property\">namespace</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"firefly-iii\"</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token property\">data</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"APP_KEY\"</span> <span class=\"token punctuation\">=</span> random_password.firefly_key.result\n    <span class=\"token property\">\"DB_USERNAME\"</span> <span class=\"token punctuation\">=</span> mysql_user.firefly.user\n    <span class=\"token property\">\"DB_PASSWORD\"</span> <span class=\"token punctuation\">=</span> random_password.firefly_password.result\n    <span class=\"token property\">\"DB_HOST\"</span> <span class=\"token punctuation\">=</span> var.mysql_host\n    <span class=\"token property\">\"DB_PORT\"</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">3306</span>\n    <span class=\"token property\">\"DB_DATABASE\"</span> <span class=\"token punctuation\">=</span> mysql_database.firefly.name\n    <span class=\"token property\">\"DB_CONNECTION\"</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"mysql\"</span>\n    <span class=\"token property\">\"MYSQL_USE_SSL\"</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"true\"</span>\n    <span class=\"token property\">\"MYSQL_SSL_VERIFY_SERVER_CERT\"</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"false\"</span>\n    <span class=\"token property\">\"MYSQL_SSL_CAPATH\"</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"/etc/ssl/certs/\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>To deploy, it’s as simple as</p>\n<div class=\"remark-highlight\"><pre class=\"language-sh\"><code class=\"language-sh\">. ./.env\nterraform apply</code></pre></div>\n<h2 id=\"the-kubernetes-app-manifest\">The Kubernetes app manifest</h2>\n<p>I can declare the Firefly III app as a StatefulSet (stateful because it needs to store some upload data). Inside a single container’s spec, we can apply all of our secrets into its environment variables with a <code>envFrom[].secretRef</code> like so:</p>\n<div class=\"remark-highlight\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> app\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> registry.hub.docker.com/jc5x/firefly<span class=\"token punctuation\">-</span>iii<span class=\"token punctuation\">:</span>latest\n  <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> TZ\n      <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> America/Los_Angeles\n  <span class=\"token key atrule\">envFrom</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">secretRef</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> firefly<span class=\"token punctuation\">-</span>db\n  <span class=\"token punctuation\">...</span>\n</code></pre></div>\n<p>After applying this manifest and its associated service and ingress, everything seems to work!</p>\n<img src=\"/_/2021/02/13/terraform-mysql-k8s/firefly-works.png\" alt=\"It&#x27;t aliiiiiive!\">\n<h2 id=\"what-next\">What next?</h2>\n<p>While this solution is much nicer and more automated than creating the database manually in a GUI or SQL script, this isn’t the most secure way to provision a user. I heard that Hashicorp Vault can actually generate new passwords specifically for one app on the fly, and I might explore that later.</p>","tags":["/projects/plebscale/","devops","kubernetes","mysql","proxmox","terraform"]}},"__N_SSG":true}