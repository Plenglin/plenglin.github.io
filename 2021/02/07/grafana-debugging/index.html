<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link title="astrid.tech RSS" rel="alternate" type="application/rss+xml" href="https://astrid.tech/rss.xml"/><link title="astrid.tech Atom" rel="alternate" type="application/atom+xml" href="https://astrid.tech/atom.xml"/><link title="astrid.tech JSON feed" rel="alternate" type="application/feed+json" href="https://astrid.tech/feed.json"/><link href="https://github.com/astralbijection" rel="me authn"/><link href="mailto:astrid@astrid.tech" rel="me"/><title>Taking pictures with Kubernetes and debugging it with Grafana | astrid.tech</title><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="description" content="A case of mistaken causes"/><meta name="twitter:card" content="summary"/><meta name="twitter:creator" content="astralbijection"/><meta name="twitter:title" content="Taking pictures with Kubernetes and debugging it with Grafana"/><meta name="twitter:description" content="A case of mistaken causes"/><meta property="og:title" content="Taking pictures with Kubernetes and debugging it with Grafana"/><meta property="og:description" content="A case of mistaken causes"/><meta property="og:type" content="website"/><meta name="robots" content="follow,index"/><meta property="og:url" content="https:/astrid.tech/2021/02/07/grafana-debugging"/><link title="astrid.tech RSS" rel="alternate" type="application/rss+xml" href="https://astrid.tech/rss.xml"/><link title="astrid.tech Atom" rel="alternate" type="application/atom+xml" href="https://astrid.tech/atom.xml"/><link title="astrid.tech JSON feed" rel="alternate" type="application/feed+json" href="https://astrid.tech/feed.json"/><link href="https://github.com/astralbijection" rel="me authn"/><link href="mailto:astrid@astrid.tech" rel="me"/><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/1d0d198a1c5bdedcad14.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1d0d198a1c5bdedcad14.css" data-n-g=""/><link rel="preload" href="/_next/static/css/bd89e56ee668535d8996.css" as="style"/><link rel="stylesheet" href="/_next/static/css/bd89e56ee668535d8996.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-e7a279300235e161e32a.js"></script><script src="/_next/static/chunks/webpack-3071412ed8bc8fc49fc7.js" defer=""></script><script src="/_next/static/chunks/framework-2f612445bd50b211f15a.js" defer=""></script><script src="/_next/static/chunks/main-6bd02c179f9e0ec2bd5a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-1658794de36b29c002aa.js" defer=""></script><script src="/_next/static/chunks/545f34e4-37710c009d2bbbd273c3.js" defer=""></script><script src="/_next/static/chunks/0c428ae2-571001351e1ed221a25c.js" defer=""></script><script src="/_next/static/chunks/1bfc9850-fc4f6c929a53a9b582f6.js" defer=""></script><script src="/_next/static/chunks/398-1b9f48eb99654eeda62b.js" defer=""></script><script src="/_next/static/chunks/264-b52c4cdeb9e69930784f.js" defer=""></script><script src="/_next/static/chunks/146-41f4f1c63257555b1b33.js" defer=""></script><script src="/_next/static/chunks/993-2df73c7cf8296f032349.js" defer=""></script><script src="/_next/static/chunks/705-c9d82552f3ea55b2fe7a.js" defer=""></script><script src="/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bday%5D/%5B...slug%5D-e11dd750811444406993.js" defer=""></script><script src="/_next/static/xu5MpDjzYRyNj4te1Gtrv/_buildManifest.js" defer=""></script><script src="/_next/static/xu5MpDjzYRyNj4te1Gtrv/_ssgManifest.js" defer=""></script></head><body><div id="__next"><nav class="main-navbar navbar navbar-expand-md fixed-top"><a href="/" class="nav-link navbar-brand">astrid.tech</a><button aria-label="Toggle navigation" type="button" class="navbar-toggler"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M250.97 29.357c-106.557-.21-211.806 52.74-203.48 164.053 138.91 11.4 276.71 8.893 414.174.662 10.58-107.69-100.753-164.498-210.693-164.715zm59.876 23.996c11.165 0 20.216 4.468 20.216 9.98 0 5.513-9.051 9.981-20.216 9.981-11.166 0-20.217-4.468-20.217-9.98 0-5.513 9.051-9.98 20.217-9.98zm-111.852 19.83c11.165 0 20.217 4.469 20.217 9.98 0 5.513-9.052 9.981-20.217 9.981s-20.216-4.468-20.217-9.98c0-5.512 9.052-9.98 20.217-9.98zm178.057 34.02c11.165 0 20.216 4.468 20.217 9.98 0 5.512-9.052 9.98-20.217 9.98s-20.217-4.468-20.217-9.98c0-5.512 9.052-9.98 20.217-9.98zm-273.59 21.535c11.165 0 20.216 4.468 20.217 9.98 0 5.513-9.052 9.98-20.217 9.98s-20.217-4.467-20.217-9.98c0-5.512 9.052-9.98 20.217-9.98zm313.77 30.043c11.165 0 20.216 4.468 20.216 9.98 0 5.512-9.051 9.98-20.217 9.98-11.165 0-20.216-4.468-20.216-9.98 0-5.512 9.051-9.98 20.216-9.98zm-137.91 8.045c11.166 0 20.218 4.47 20.216 9.982 0 5.512-9.051 9.98-20.217 9.98-11.165 0-20.216-4.468-20.216-9.98-.002-5.513 9.05-9.982 20.216-9.982zM57.618 212.339c-18.964.405-9.028 24.485 14.383 24.573 128.554 10.208 236.673 9.686 372.117-2.42 16.096-2.708 25.212-13.087 10.824-21.969-131.579 7.67-263.81 10.045-397.324-.184zm403.024 40.612c-131.224 13.6-277.594 10.525-390.065 1.904-46.983-6.226-47.875 46.785-17.014 52.309 146.18 14.663 271.826 10.735 415.137-.53 25.007-1.144 14.554-55.328-8.058-53.683zM20.986 366.679l15.332 9.434c6.342-8.416 17.876-32.05 33.319-32.192 19.122-.174 22.345 39.302 41.98 39.103 22.607-.228 37.828-31.548 52.447-30.882 22.09 1.008 26.333 35.9 43.557 35.928 24.089.04 31.439-36.39 46.805-35.334 21.458 1.475 33.246 28.274 50.879 29.178 19.004.974 30.654-33.027 43.265-32.748 16.61.366 28.31 32.46 54.24 33.193 15.345.434 29.694-37.411 37.005-36.815 14.417 1.174 26.549 20.548 36.085 34.835l15.114-9.776c-12.029-16.216-30.117-44.428-52.558-44.017-20.907.382-25.948 38.114-38.102 37.943-23.28-.328-33.756-32.164-52.598-33.346-19.356-1.214-30.475 33.636-43.353 32.768-18.954-1.277-27.303-29.16-49.475-29.917-19.62-.67-34.121 37.669-46.793 36.044-18.139-2.326-20.226-36.378-43.317-37.836-19.11-1.207-37.562 30.604-50.314 29.999-17.525-.833-25.243-40.224-45.41-39.986-21.826.258-39.145 30.34-48.108 44.424zm47.553 36.174c-8.342.686-18.198 4.251-21.85 12.424-2.452 6.662 19.173 8.558 21.114 8.695 128.615 8.104 254.354 8.26 389.8-1.345 9.225-.655 13.935-3.147 15.252-4.414 3.124-8.208-23.168-13.935-25.818-14.004-185.01-1.178-279.257 2.209-378.498-1.356zm395.555 37.192c-126.786 6.957-283.18 9.384-408.123.707l.521 38.67c135.917 4.617 275.647 3.99 406.658-.088z"></path></svg></button><div class="collapse navbar-collapse"><a class="nav-link" href="/projects/">Projects</a><a class="nav-link active" href="/latest/">Blog</a><div class="navbar-separator"></div><a class="nav-link" href="/about/">About</a></div></nav><div class="root-wrapper expand-height"><div class="text-light large" style="background-color:black;margin:0;padding:15px;padding-left:30px;padding-right:30px"><p style="text-align:center;margin:0"><b>Black Lives Matter.</b> Please consider donating to the<!-- --> <a href="https://www.paypal.me/SLOBailFund">San Luis Obispo, CA Bail Fund</a> <!-- -->or <a href="https://bailfunds.github.io">other bail funds</a> so we can make the world a just and equitable place for all people of all colors.</p></div><div style="background-color:#e6b3e2"><nav class="page-heading_above__2RV0m"></nav><header class="page-heading_header__zwjn1"><h1>Taking pictures with Kubernetes and debugging it with Grafana</h1><p>A case of mistaken causes</p></header></div><div class="longform-layout_container__1bKFt container"><div class="row"><div class="longform-layout_content__gfokN col-lg-8"><article class="longform"><article class="longform"><div><p>A 7-node server cluster would be terrible to monitor if you had to SSH and <code>top</code> every individual node. Thankfully, that’s where Grafana and Prometheus come in to save the day.</p>
<!-- -->
<a href="/_/2021/02/07/grafana-debugging/everything-dashboard.png"><img src="/_/2021/02/07/grafana-debugging/everything-dashboard.png" alt="What my Grafana dashboard currently looks like. Resist... the... urge... to... make... &quot;Look at this graph&quot;... references..." width="1200"/></a>
<h2 id="deploying-my-monitoring-and-redeploying-my-logging">Deploying my monitoring and redeploying my logging</h2>
<p>After much finagling with Kubernetes manifests and general pain, I learned about <a href="https://helm.sh/">Helm Charts</a>, which is essentially a package manager for Kubernetes. I have a <a href="https://github.com/roboll/helmfile">Helmfile</a> set up to essentially declaratively deploy my Charts, as well.</p>
<p>So, I got Prometheus and Grafana set up using the <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack"><code>prometheus-community/kube-prometheus-stack</code></a> helm chart, which bundles all the metrics stuff together into one nice package. I also redeployed my logging stack using the <a href="https://github.com/bitnami/charts/tree/master/bitnami/fluentd/"><code>bitnami/fluentd</code></a>, <a href="https://github.com/fluent/helm-charts"><code>fluent/fluent-bit</code></a>, <a href="https://github.com/elastic/helm-charts/tree/master/elasticsearch"><code>elastic/elasticsearch</code></a>, and <a href="https://github.com/elastic/helm-charts/tree/master/kibana"><code>elastic/kibana</code></a>.</p>
<a href="/_/2021/02/07/grafana-debugging/a29f29b47d40ccba85837d0a490a153f282597ca.svg"><img src="/_/2021/02/07/grafana-debugging/a29f29b47d40ccba85837d0a490a153f282597ca.svg" title="`dot` image" width="1200"/></a>
<p>Here’s a small chart demonstrating how my full monitoring stack works.</p>
<p>A log might go through the following process:</p>
<ol>
<li>The container writes a log to stdout or stderr, or systemd produces a log.</li>
<li>Every node runs Fluent-bit, which is a very lightweight log forwarder. Fluent-bit just reads every container’s output, does very minimal parsing of the log, gives it a tag (in the form of <code>kube.infra.&lt;namespace_name&gt;.&lt;pod_name&gt;.&lt;container_name&gt;</code>), and sends it off to the central Fluentd aggregation service.</li>
<li>Fluentd receives logs from Fluent-bit and turns them into JSON based on predefined rules. So far, I have processing set up for Nginx and Kibana. Then, Fluentd writes the data to Elasticsearch.</li>
<li>Finally, I can read the logs from Elasticsearch using Kibana or Grafana, depending on my mood, though it’s usually Kibana.</li>
</ol>
<p>Metrics data is slightly different.</p>
<ol>
<li>A node exporter app runs on every node, reading CPU, load, memory, and other fun metrics, and exposes it as a HTTP server.</li>
<li>Every 10 seconds, Prometheus scrapes this data from all the nodes’ exporters and stores it on disk.</li>
<li>Finally, I can look at the cool graphs that Grafana produces from this data stored in Prometheus.</li>
</ol>
<h2 id="kaap-kubernetes-as-a-paparazza">KaaP: Kubernetes as a Paparazza</h2>
<p>This is it! I’m finally running <em>something</em> on this godforsaken cluster!</p>
<p>At the last <a href="https://indieweb.org/Homebrew_Website_Club">IndieWeb Homebrew Website Club (HWC)</a> I attended, someone suggested to me that I could somehow have a live feed of my 3D printer. Although I can’t have a <em>live</em> feed because I have a slow internet connection, I can take a picture every few minutes and upload it to my server.</p>
<p>So, I added a new endpoint to my API server, then wrote a <a href="https://github.com/astralbijection/printer_image_snapper">small script</a> that does exactly that. It scrapes data from my OctoPrint instance’s API, snaps a picture from the exposed MJPG-streamer endpoint, and sends a PATCH request to my API server with all the information. I <a href="https://hub.docker.com/repository/docker/astridyu/printer_image_snapper">Dockerized it</a> using <code>python3.9-alpine</code> for minimum image size, and created a CronJob for my cluster that runs the script every 10 minutes:<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup></p>
<div class="remark-highlight"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> printer<span class="token punctuation">-</span>image<span class="token punctuation">-</span>snapper
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> printer<span class="token punctuation">-</span>image<span class="token punctuation">-</span>snapper
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> printer<span class="token punctuation">-</span>image<span class="token punctuation">-</span>snapper
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">&quot;*/10 * * * *&quot;</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
            <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
              <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
                <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/arch
                        <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                        <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>amd64<span class="token punctuation">]</span>
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> printer<span class="token punctuation">-</span>image<span class="token punctuation">-</span>snapper
              <span class="token key atrule">image</span><span class="token punctuation">:</span> astridyu/printer_image_snapper<span class="token punctuation">:</span>latest
              <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
              <span class="token key atrule">env</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SNAPSHOT_URL
                  <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.1.73/webcam/<span class="token punctuation">?</span>action=snapshot
                <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PRINTER_ENDPOINT
                  <span class="token key atrule">value</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//api.astrid.tech/api/3dprinter/1/
                <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OCTOPRINT_ROOT
                  <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.1.73/
              <span class="token key atrule">envFrom</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">secretRef</span><span class="token punctuation">:</span>
                    <span class="token key atrule">name</span><span class="token punctuation">:</span> printer<span class="token punctuation">-</span>image<span class="token punctuation">-</span>snapper
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure
</code></pre></div>
<p>I deployed it and found that my script was broken. However, I was tired, so I just went to bed.</p>
<h2 id="debugging-time">Debugging time</h2>
<p>When I woke up the next morning on Wednesday, I saw the weirdest thing happen on Grafana.</p>
<a href="/_/2021/02/07/grafana-debugging/repeated-spikes.png"><img src="/_/2021/02/07/grafana-debugging/repeated-spikes.png" alt="What&#x27;s with these spikes?" width="1200"/></a>
<p>There were these strange, very noticeable spikes in memory consumption every few minutes. Worse, they seemed to be 1 GB tall!</p>
<a href="/_/2021/02/07/grafana-debugging/1gb-spikes.png"><img src="/_/2021/02/07/grafana-debugging/1gb-spikes.png" alt="One jiggabyte tall!" width="1200"/></a>
<p>How bad could my Docker image be? It runs Python, which isn’t exactly a lightweight runtime, but it wouldn’t be 1 GB either. It stores a very low-res JPEG of my printer in RAM, probably at most 30 KB, and it doesn’t send much extra data.</p>
<p>My mom’s old laptop was also running at 18 load (it has 4 cores, mind you) because Elasticsearch got assigned to it, but I didn’t pay it much mind.</p>
<a href="/_/2021/02/07/grafana-debugging/massive-load.png"><img src="/_/2021/02/07/grafana-debugging/massive-load.png" alt="what the fuck" width="1200"/></a>
<p>I continued debugging my script that afternoon, checking for, well, honestly, I don’t know what would be causing it. In a stroke of bad luck, Docker Hub happened to be freaking out on that day/week and taking extremely long on my builds, and not because I wrote inefficient code. Here’s an image from my <a href="https://hub.docker.com/repository/docker/astridyu/astrid_tech_api">API server’s repository</a>. Yes, those are 177-minute queue times and 252-minute build times. But that had nothing to do with my problem, it only made debugging and testing cycles harder.</p>
<a href="/_/2021/02/07/grafana-debugging/long-build-times.png"><img src="/_/2021/02/07/grafana-debugging/long-build-times.png" alt="what the actual fuck" width="1200"/></a>
<p>I did eventually get the script working (see the second image <a href="https://astrid.tech/projects/quadfrost-leds/">here</a> for now, but I will make a dedicated page for it eventually).</p>
<p>Then, after demoing my printer images it during the HWC meeting, I remembered: there was one Elasticsearch pod that was always crashing because it kept going OOM on my mom’s old laptop, wasn’t it? So, I added a new graph to my dashboard called “Poorly-Terminated Containers.” It’s a heatmap of container terminations that aren’t because of <code>Completed</code>.</p>
<a href="/_/2021/02/07/grafana-debugging/poorly-terminated-containers.png"><img src="/_/2021/02/07/grafana-debugging/poorly-terminated-containers.png" alt="It&#x27;s like a shitty spectrogram!" width="1200"/></a>
<p>According to this graph, my printer paparazza stopped crashing halfway through the afternoon when I fixed it, but my logging namespace continued doing so.</p>
<a href="/_/2021/02/07/grafana-debugging/correlation-time.png"><img src="/_/2021/02/07/grafana-debugging/correlation-time.png" alt="It&#x27;s a crash spectrogram!" width="1200"/></a>
<p>And sure enough, every one of these crashes seems to correspond with that 1GB drop in memory usage.</p>
<p>Yeah, it’s Elasticsearch being too damn big and getting killed for it.</p>
<h2 id="what-now">What now?</h2>
<p>I tried tweaking Elasticsearch a bit, maybe running it on my Raspberry Pis instead, but I wasn’t able to really do much. So, I shut it down and freed up 2.5 GB of memory across my entire cluster, which is 1/3 of what I use in total. Given that my cluster is composed of very small and low-powered devices, I don’t think Elasticsearch is a very good option for me. I’ll have to look into more lightweight logging systems. I’ve heard Loki is a good option, and there is a Fluentd plugin for it.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn-1">Yes, I know this can be run on a normal server with a normal cronjob. I just wanted to try something new and give my cluster a purpose, okay?<a href="#fnref-1" class="footnote-backref">↩</a></li>
</ol>
</div></div></article></article></div><div class="col-lg-4"><div class="longform-layout_sidebarGroup__1maJR"><table style="width:100%"><tbody><tr><th style="min-width:180px"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm436-44v-36c0-26.5-21.5-48-48-48h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v36c0 6.6 5.4 12 12 12h424c6.6 0 12-5.4 12-12z"></path></svg> <!-- -->Date</th><td class="longform-layout_statusData__1GlEa">7 Feb 2021</td></tr></tbody></table></div><div class="longform-layout_sidebarGroup__1maJR"><h2>Tags</h2><div><p style="font-size:12pt;margin-bottom:3px"><a href="/projects/plebscale/"><span style="background-color:#86e600;color:#000000;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">/projects/plebscale/</span></a><a href="/projects/quadfrost-leds/"><span style="background-color:#143bff;color:#ffffff;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">/projects/quadfrost-leds/</span></a><a href="/t/devops"><span style="background-color:#47e000;color:#000000;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">devops</span></a><a href="/t/grafana"><span style="background-color:#6200a3;color:#ffffff;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">grafana</span></a><a href="/t/kubernetes"><span style="background-color:#0039f5;color:#ffffff;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">kubernetes</span></a> </p></div></div></div></div></div><div class="container"><section id="comments"><h2>Comments</h2><div class="comments"><div><form class=""><div class="row form-group"><label for="comment-name" class="col-sm-4 col-form-label">Name (leave blank for anonymous)</label><div class="col-sm-8"><input type="text" name="name" id="comment-name" placeholder="Willy Shakespeare" class="form-control"/></div></div><div class="row form-group"><label for="comment-email" class="col-sm-4 col-form-label">Email (required)</label><div class="col-sm-8"><input type="email" name="email" id="comment-email" placeholder="user@example.com" class="form-control"/></div></div><div class="row form-group"><label for="comment-website" class="col-sm-4 col-form-label">Website</label><div class="col-sm-8"><input type="url" name="website" id="comment-website" placeholder="my.cool.site" class="form-control"/></div></div><div class="form-group"><label for="comment-body" class="">Comment (<!-- -->1000<!-- --> chars left)</label><textarea name="body" id="comment-body" placeholder="Type your comment here..." class="form-control"></textarea><small class="form-text text-muted">Markdown formatting is supported.</small></div><div class="row"><button type="button" class="btn btn-primary">Submit!</button></div></form></div></div></section></div></div><footer class="footer_footer__1KZqX"><div class="text-light small container"><div class="col"><nav class="row"><div class="col-6 col-sm-4"><a href="/privacy/">Privacy Policy</a></div><div class="col-6 col-sm-4"><a href="/licenses/">Open Source Licenses</a></div><div class="col-6 col-sm-4"><a href="/about/">About/Contact</a></div></nav></div><div class="col"><p>astrid.tech v<!-- -->2.0.0<!-- --> was created by Astrid Yu with a generous helping of <span title="tea" aria-label="tea" role="img">☕</span> and <span title="witchcraft" aria-label="witchcraft" role="img">🧙‍</span>. See the<!-- --> <a href="/projects/astrid-tech/">self-referential project page</a> <!-- -->or see the code yourself on<!-- --> <a href="https://github.com/astralbijection/astrid.tech">GitHub</a>.</p></div><div class="row"><div class="col"></div></div><div class="row"><div class="text-center col"><a href="https://www.gnu.org/licenses/agpl-3.0.en.html"><img alt="GNU Affero General Public License" width="100" height="40" src="/agpl.png"/></a><p><a href="https://github.com/astralbijection/astrid.tech">The source code of astrid.tech</a> <!-- -->is licensed under the<!-- --> <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">AGPL License</a>.<!-- --> </p></div><div class="text-center col"><p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/></a><br/><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">The page content of astrid.tech</span> <!-- -->by<!-- --> <a xmlns:cc="http://creativecommons.org/ns#" href="https://astrid.tech" property="cc:attributionName" rel="cc:attributionURL">Astrid Yu</a> <!-- -->is licensed under a<!-- --> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":6,"assetRoot":"2021/02/07/grafana-debugging","thumbnail":null,"title":"Taking pictures with Kubernetes and debugging it with Grafana","description":"A case of mistaken causes","slug":"grafana-debugging","date":"2021-02-07T10:37:00.000Z","content":"\u003cp\u003eA 7-node server cluster would be terrible to monitor if you had to SSH and \u003ccode\u003etop\u003c/code\u003e every individual node. Thankfully, that’s where Grafana and Prometheus come in to save the day.\u003c/p\u003e\n\u003c!-- excerpt --\u003e\n\u003cimg src=\"/_/2021/02/07/grafana-debugging/everything-dashboard.png\" alt=\"What my Grafana dashboard currently looks like. Resist... the... urge... to... make... \u0026#x22;Look at this graph\u0026#x22;... references...\"\u003e\n\u003ch2 id=\"deploying-my-monitoring-and-redeploying-my-logging\"\u003eDeploying my monitoring and redeploying my logging\u003c/h2\u003e\n\u003cp\u003eAfter much finagling with Kubernetes manifests and general pain, I learned about \u003ca href=\"https://helm.sh/\"\u003eHelm Charts\u003c/a\u003e, which is essentially a package manager for Kubernetes. I have a \u003ca href=\"https://github.com/roboll/helmfile\"\u003eHelmfile\u003c/a\u003e set up to essentially declaratively deploy my Charts, as well.\u003c/p\u003e\n\u003cp\u003eSo, I got Prometheus and Grafana set up using the \u003ca href=\"https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack\"\u003e\u003ccode\u003eprometheus-community/kube-prometheus-stack\u003c/code\u003e\u003c/a\u003e helm chart, which bundles all the metrics stuff together into one nice package. I also redeployed my logging stack using the \u003ca href=\"https://github.com/bitnami/charts/tree/master/bitnami/fluentd/\"\u003e\u003ccode\u003ebitnami/fluentd\u003c/code\u003e\u003c/a\u003e, \u003ca href=\"https://github.com/fluent/helm-charts\"\u003e\u003ccode\u003efluent/fluent-bit\u003c/code\u003e\u003c/a\u003e, \u003ca href=\"https://github.com/elastic/helm-charts/tree/master/elasticsearch\"\u003e\u003ccode\u003eelastic/elasticsearch\u003c/code\u003e\u003c/a\u003e, and \u003ca href=\"https://github.com/elastic/helm-charts/tree/master/kibana\"\u003e\u003ccode\u003eelastic/kibana\u003c/code\u003e\u003c/a\u003e.\u003c/p\u003e\n\u003cimg src=\"/_/2021/02/07/grafana-debugging/a29f29b47d40ccba85837d0a490a153f282597ca.svg\" title=\"\u0026#x60;dot\u0026#x60; image\"\u003e\n\u003cp\u003eHere’s a small chart demonstrating how my full monitoring stack works.\u003c/p\u003e\n\u003cp\u003eA log might go through the following process:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eThe container writes a log to stdout or stderr, or systemd produces a log.\u003c/li\u003e\n\u003cli\u003eEvery node runs Fluent-bit, which is a very lightweight log forwarder. Fluent-bit just reads every container’s output, does very minimal parsing of the log, gives it a tag (in the form of \u003ccode\u003ekube.infra.\u0026#x3C;namespace_name\u003e.\u0026#x3C;pod_name\u003e.\u0026#x3C;container_name\u003e\u003c/code\u003e), and sends it off to the central Fluentd aggregation service.\u003c/li\u003e\n\u003cli\u003eFluentd receives logs from Fluent-bit and turns them into JSON based on predefined rules. So far, I have processing set up for Nginx and Kibana. Then, Fluentd writes the data to Elasticsearch.\u003c/li\u003e\n\u003cli\u003eFinally, I can read the logs from Elasticsearch using Kibana or Grafana, depending on my mood, though it’s usually Kibana.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eMetrics data is slightly different.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eA node exporter app runs on every node, reading CPU, load, memory, and other fun metrics, and exposes it as a HTTP server.\u003c/li\u003e\n\u003cli\u003eEvery 10 seconds, Prometheus scrapes this data from all the nodes’ exporters and stores it on disk.\u003c/li\u003e\n\u003cli\u003eFinally, I can look at the cool graphs that Grafana produces from this data stored in Prometheus.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"kaap-kubernetes-as-a-paparazza\"\u003eKaaP: Kubernetes as a Paparazza\u003c/h2\u003e\n\u003cp\u003eThis is it! I’m finally running \u003cem\u003esomething\u003c/em\u003e on this godforsaken cluster!\u003c/p\u003e\n\u003cp\u003eAt the last \u003ca href=\"https://indieweb.org/Homebrew_Website_Club\"\u003eIndieWeb Homebrew Website Club (HWC)\u003c/a\u003e I attended, someone suggested to me that I could somehow have a live feed of my 3D printer. Although I can’t have a \u003cem\u003elive\u003c/em\u003e feed because I have a slow internet connection, I can take a picture every few minutes and upload it to my server.\u003c/p\u003e\n\u003cp\u003eSo, I added a new endpoint to my API server, then wrote a \u003ca href=\"https://github.com/astralbijection/printer_image_snapper\"\u003esmall script\u003c/a\u003e that does exactly that. It scrapes data from my OctoPrint instance’s API, snaps a picture from the exposed MJPG-streamer endpoint, and sends a PATCH request to my API server with all the information. I \u003ca href=\"https://hub.docker.com/repository/docker/astridyu/printer_image_snapper\"\u003eDockerized it\u003c/a\u003e using \u003ccode\u003epython3.9-alpine\u003c/code\u003e for minimum image size, and created a CronJob for my cluster that runs the script every 10 minutes:\u003csup id=\"fnref-1\"\u003e\u003ca href=\"#fn-1\" class=\"footnote-ref\"\u003e1\u003c/a\u003e\u003c/sup\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token key atrule\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e v1\n\u003cspan class=\"token key atrule\"\u003ekind\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Namespace\n\u003cspan class=\"token key atrule\"\u003emetadata\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e printer\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003eimage\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003esnapper\n\u003cspan class=\"token punctuation\"\u003e---\u003c/span\u003e\n\u003cspan class=\"token key atrule\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e batch/v1beta1\n\u003cspan class=\"token key atrule\"\u003ekind\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e CronJob\n\u003cspan class=\"token key atrule\"\u003emetadata\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e printer\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003eimage\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003esnapper\n  \u003cspan class=\"token key atrule\"\u003enamespace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e printer\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003eimage\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003esnapper\n\u003cspan class=\"token key atrule\"\u003espec\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003eschedule\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"*/10 * * * *\"\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003ejobTemplate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003espec\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token key atrule\"\u003etemplate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token key atrule\"\u003espec\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"token key atrule\"\u003eaffinity\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"token key atrule\"\u003enodeAffinity\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n              \u003cspan class=\"token key atrule\"\u003erequiredDuringSchedulingIgnoredDuringExecution\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"token key atrule\"\u003enodeSelectorTerms\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n                  \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ematchExpressions\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n                      \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ekey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e kubernetes.io/arch\n                        \u003cspan class=\"token key atrule\"\u003eoperator\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e In\n                        \u003cspan class=\"token key atrule\"\u003evalues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eamd64\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n          \u003cspan class=\"token key atrule\"\u003econtainers\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e printer\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003eimage\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003esnapper\n              \u003cspan class=\"token key atrule\"\u003eimage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e astridyu/printer_image_snapper\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003elatest\n              \u003cspan class=\"token key atrule\"\u003eimagePullPolicy\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Always\n              \u003cspan class=\"token key atrule\"\u003eenv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e SNAPSHOT_URL\n                  \u003cspan class=\"token key atrule\"\u003evalue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e//192.168.1.73/webcam/\u003cspan class=\"token punctuation\"\u003e?\u003c/span\u003eaction=snapshot\n                \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e PRINTER_ENDPOINT\n                  \u003cspan class=\"token key atrule\"\u003evalue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e https\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e//api.astrid.tech/api/3dprinter/1/\n                \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e OCTOPRINT_ROOT\n                  \u003cspan class=\"token key atrule\"\u003evalue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e//192.168.1.73/\n              \u003cspan class=\"token key atrule\"\u003eenvFrom\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003esecretRef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e printer\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003eimage\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003esnapper\n          \u003cspan class=\"token key atrule\"\u003erestartPolicy\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e OnFailure\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eI deployed it and found that my script was broken. However, I was tired, so I just went to bed.\u003c/p\u003e\n\u003ch2 id=\"debugging-time\"\u003eDebugging time\u003c/h2\u003e\n\u003cp\u003eWhen I woke up the next morning on Wednesday, I saw the weirdest thing happen on Grafana.\u003c/p\u003e\n\u003cimg src=\"/_/2021/02/07/grafana-debugging/repeated-spikes.png\" alt=\"What\u0026#x27;s with these spikes?\"\u003e\n\u003cp\u003eThere were these strange, very noticeable spikes in memory consumption every few minutes. Worse, they seemed to be 1 GB tall!\u003c/p\u003e\n\u003cimg src=\"/_/2021/02/07/grafana-debugging/1gb-spikes.png\" alt=\"One jiggabyte tall!\"\u003e\n\u003cp\u003eHow bad could my Docker image be? It runs Python, which isn’t exactly a lightweight runtime, but it wouldn’t be 1 GB either. It stores a very low-res JPEG of my printer in RAM, probably at most 30 KB, and it doesn’t send much extra data.\u003c/p\u003e\n\u003cp\u003eMy mom’s old laptop was also running at 18 load (it has 4 cores, mind you) because Elasticsearch got assigned to it, but I didn’t pay it much mind.\u003c/p\u003e\n\u003cimg src=\"/_/2021/02/07/grafana-debugging/massive-load.png\" alt=\"what the fuck\"\u003e\n\u003cp\u003eI continued debugging my script that afternoon, checking for, well, honestly, I don’t know what would be causing it. In a stroke of bad luck, Docker Hub happened to be freaking out on that day/week and taking extremely long on my builds, and not because I wrote inefficient code. Here’s an image from my \u003ca href=\"https://hub.docker.com/repository/docker/astridyu/astrid_tech_api\"\u003eAPI server’s repository\u003c/a\u003e. Yes, those are 177-minute queue times and 252-minute build times. But that had nothing to do with my problem, it only made debugging and testing cycles harder.\u003c/p\u003e\n\u003cimg src=\"/_/2021/02/07/grafana-debugging/long-build-times.png\" alt=\"what the actual fuck\"\u003e\n\u003cp\u003eI did eventually get the script working (see the second image \u003ca href=\"https://astrid.tech/projects/quadfrost-leds/\"\u003ehere\u003c/a\u003e for now, but I will make a dedicated page for it eventually).\u003c/p\u003e\n\u003cp\u003eThen, after demoing my printer images it during the HWC meeting, I remembered: there was one Elasticsearch pod that was always crashing because it kept going OOM on my mom’s old laptop, wasn’t it? So, I added a new graph to my dashboard called “Poorly-Terminated Containers.” It’s a heatmap of container terminations that aren’t because of \u003ccode\u003eCompleted\u003c/code\u003e.\u003c/p\u003e\n\u003cimg src=\"/_/2021/02/07/grafana-debugging/poorly-terminated-containers.png\" alt=\"It\u0026#x27;s like a shitty spectrogram!\"\u003e\n\u003cp\u003eAccording to this graph, my printer paparazza stopped crashing halfway through the afternoon when I fixed it, but my logging namespace continued doing so.\u003c/p\u003e\n\u003cimg src=\"/_/2021/02/07/grafana-debugging/correlation-time.png\" alt=\"It\u0026#x27;s a crash spectrogram!\"\u003e\n\u003cp\u003eAnd sure enough, every one of these crashes seems to correspond with that 1GB drop in memory usage.\u003c/p\u003e\n\u003cp\u003eYeah, it’s Elasticsearch being too damn big and getting killed for it.\u003c/p\u003e\n\u003ch2 id=\"what-now\"\u003eWhat now?\u003c/h2\u003e\n\u003cp\u003eI tried tweaking Elasticsearch a bit, maybe running it on my Raspberry Pis instead, but I wasn’t able to really do much. So, I shut it down and freed up 2.5 GB of memory across my entire cluster, which is 1/3 of what I use in total. Given that my cluster is composed of very small and low-powered devices, I don’t think Elasticsearch is a very good option for me. I’ll have to look into more lightweight logging systems. I’ve heard Loki is a good option, and there is a Fluentd plugin for it.\u003c/p\u003e\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\u003cli id=\"fn-1\"\u003eYes, I know this can be run on a normal server with a normal cronjob. I just wanted to try something new and give my cluster a purpose, okay?\u003ca href=\"#fnref-1\" class=\"footnote-backref\"\u003e↩\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/div\u003e","tags":["/projects/plebscale/","/projects/quadfrost-leds/","devops","grafana","kubernetes"]}},"__N_SSG":true},"page":"/[year]/[month]/[day]/[...slug]","query":{"year":"2021","month":"02","day":"07","slug":["grafana-debugging"]},"buildId":"xu5MpDjzYRyNj4te1Gtrv","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>