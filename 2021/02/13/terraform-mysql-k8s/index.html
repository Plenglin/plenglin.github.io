<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link title="astrid.tech RSS" rel="alternate" type="application/rss+xml" href="https://astrid.tech/rss.xml"/><link title="astrid.tech Atom" rel="alternate" type="application/atom+xml" href="https://astrid.tech/atom.xml"/><link title="astrid.tech JSON feed" rel="alternate" type="application/feed+json" href="https://astrid.tech/feed.json"/><link href="https://github.com/astralbijection" rel="me authn"/><link href="mailto:astrid@astrid.tech" rel="me"/><title>Declaratively Provision Databases and Submit Credentials to Kubernetes using Terraform | astrid.tech</title><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="description" content="DATABASES! I didn&#x27;t say it, I DECLARED it!"/><meta name="twitter:card" content="summary"/><meta name="twitter:creator" content="astralbijection"/><meta name="twitter:title" content="Declaratively Provision Databases and Submit Credentials to Kubernetes using Terraform"/><meta name="twitter:description" content="DATABASES! I didn&#x27;t say it, I DECLARED it!"/><meta property="og:title" content="Declaratively Provision Databases and Submit Credentials to Kubernetes using Terraform"/><meta property="og:description" content="DATABASES! I didn&#x27;t say it, I DECLARED it!"/><meta property="og:type" content="website"/><meta name="robots" content="follow,index"/><meta property="og:url" content="https:/astrid.tech/2021/02/13/terraform-mysql-k8s"/><link title="astrid.tech RSS" rel="alternate" type="application/rss+xml" href="https://astrid.tech/rss.xml"/><link title="astrid.tech Atom" rel="alternate" type="application/atom+xml" href="https://astrid.tech/atom.xml"/><link title="astrid.tech JSON feed" rel="alternate" type="application/feed+json" href="https://astrid.tech/feed.json"/><link href="https://github.com/astralbijection" rel="me authn"/><link href="mailto:astrid@astrid.tech" rel="me"/><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/1d0d198a1c5bdedcad14.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1d0d198a1c5bdedcad14.css" data-n-g=""/><link rel="preload" href="/_next/static/css/bd89e56ee668535d8996.css" as="style"/><link rel="stylesheet" href="/_next/static/css/bd89e56ee668535d8996.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-e7a279300235e161e32a.js"></script><script src="/_next/static/chunks/webpack-3071412ed8bc8fc49fc7.js" defer=""></script><script src="/_next/static/chunks/framework-2f612445bd50b211f15a.js" defer=""></script><script src="/_next/static/chunks/main-6bd02c179f9e0ec2bd5a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-1658794de36b29c002aa.js" defer=""></script><script src="/_next/static/chunks/545f34e4-37710c009d2bbbd273c3.js" defer=""></script><script src="/_next/static/chunks/0c428ae2-571001351e1ed221a25c.js" defer=""></script><script src="/_next/static/chunks/1bfc9850-fc4f6c929a53a9b582f6.js" defer=""></script><script src="/_next/static/chunks/398-1b9f48eb99654eeda62b.js" defer=""></script><script src="/_next/static/chunks/264-b52c4cdeb9e69930784f.js" defer=""></script><script src="/_next/static/chunks/146-41f4f1c63257555b1b33.js" defer=""></script><script src="/_next/static/chunks/993-2df73c7cf8296f032349.js" defer=""></script><script src="/_next/static/chunks/705-c9d82552f3ea55b2fe7a.js" defer=""></script><script src="/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bday%5D/%5B...slug%5D-e11dd750811444406993.js" defer=""></script><script src="/_next/static/xu5MpDjzYRyNj4te1Gtrv/_buildManifest.js" defer=""></script><script src="/_next/static/xu5MpDjzYRyNj4te1Gtrv/_ssgManifest.js" defer=""></script></head><body><div id="__next"><nav class="main-navbar navbar navbar-expand-md fixed-top"><a href="/" class="nav-link navbar-brand">astrid.tech</a><button aria-label="Toggle navigation" type="button" class="navbar-toggler"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M250.97 29.357c-106.557-.21-211.806 52.74-203.48 164.053 138.91 11.4 276.71 8.893 414.174.662 10.58-107.69-100.753-164.498-210.693-164.715zm59.876 23.996c11.165 0 20.216 4.468 20.216 9.98 0 5.513-9.051 9.981-20.216 9.981-11.166 0-20.217-4.468-20.217-9.98 0-5.513 9.051-9.98 20.217-9.98zm-111.852 19.83c11.165 0 20.217 4.469 20.217 9.98 0 5.513-9.052 9.981-20.217 9.981s-20.216-4.468-20.217-9.98c0-5.512 9.052-9.98 20.217-9.98zm178.057 34.02c11.165 0 20.216 4.468 20.217 9.98 0 5.512-9.052 9.98-20.217 9.98s-20.217-4.468-20.217-9.98c0-5.512 9.052-9.98 20.217-9.98zm-273.59 21.535c11.165 0 20.216 4.468 20.217 9.98 0 5.513-9.052 9.98-20.217 9.98s-20.217-4.467-20.217-9.98c0-5.512 9.052-9.98 20.217-9.98zm313.77 30.043c11.165 0 20.216 4.468 20.216 9.98 0 5.512-9.051 9.98-20.217 9.98-11.165 0-20.216-4.468-20.216-9.98 0-5.512 9.051-9.98 20.216-9.98zm-137.91 8.045c11.166 0 20.218 4.47 20.216 9.982 0 5.512-9.051 9.98-20.217 9.98-11.165 0-20.216-4.468-20.216-9.98-.002-5.513 9.05-9.982 20.216-9.982zM57.618 212.339c-18.964.405-9.028 24.485 14.383 24.573 128.554 10.208 236.673 9.686 372.117-2.42 16.096-2.708 25.212-13.087 10.824-21.969-131.579 7.67-263.81 10.045-397.324-.184zm403.024 40.612c-131.224 13.6-277.594 10.525-390.065 1.904-46.983-6.226-47.875 46.785-17.014 52.309 146.18 14.663 271.826 10.735 415.137-.53 25.007-1.144 14.554-55.328-8.058-53.683zM20.986 366.679l15.332 9.434c6.342-8.416 17.876-32.05 33.319-32.192 19.122-.174 22.345 39.302 41.98 39.103 22.607-.228 37.828-31.548 52.447-30.882 22.09 1.008 26.333 35.9 43.557 35.928 24.089.04 31.439-36.39 46.805-35.334 21.458 1.475 33.246 28.274 50.879 29.178 19.004.974 30.654-33.027 43.265-32.748 16.61.366 28.31 32.46 54.24 33.193 15.345.434 29.694-37.411 37.005-36.815 14.417 1.174 26.549 20.548 36.085 34.835l15.114-9.776c-12.029-16.216-30.117-44.428-52.558-44.017-20.907.382-25.948 38.114-38.102 37.943-23.28-.328-33.756-32.164-52.598-33.346-19.356-1.214-30.475 33.636-43.353 32.768-18.954-1.277-27.303-29.16-49.475-29.917-19.62-.67-34.121 37.669-46.793 36.044-18.139-2.326-20.226-36.378-43.317-37.836-19.11-1.207-37.562 30.604-50.314 29.999-17.525-.833-25.243-40.224-45.41-39.986-21.826.258-39.145 30.34-48.108 44.424zm47.553 36.174c-8.342.686-18.198 4.251-21.85 12.424-2.452 6.662 19.173 8.558 21.114 8.695 128.615 8.104 254.354 8.26 389.8-1.345 9.225-.655 13.935-3.147 15.252-4.414 3.124-8.208-23.168-13.935-25.818-14.004-185.01-1.178-279.257 2.209-378.498-1.356zm395.555 37.192c-126.786 6.957-283.18 9.384-408.123.707l.521 38.67c135.917 4.617 275.647 3.99 406.658-.088z"></path></svg></button><div class="collapse navbar-collapse"><a class="nav-link" href="/projects/">Projects</a><a class="nav-link active" href="/latest/">Blog</a><div class="navbar-separator"></div><a class="nav-link" href="/about/">About</a></div></nav><div class="root-wrapper expand-height"><div class="text-light large" style="background-color:black;margin:0;padding:15px;padding-left:30px;padding-right:30px"><p style="text-align:center;margin:0"><b>Black Lives Matter.</b> Please consider donating to the<!-- --> <a href="https://www.paypal.me/SLOBailFund">San Luis Obispo, CA Bail Fund</a> <!-- -->or <a href="https://bailfunds.github.io">other bail funds</a> so we can make the world a just and equitable place for all people of all colors.</p></div><div style="background-color:#e6b3c5"><nav class="page-heading_above__2RV0m"></nav><header class="page-heading_header__zwjn1"><h1>Declaratively Provision Databases and Submit Credentials to Kubernetes using Terraform</h1><p>DATABASES! I didn&#x27;t say it, I DECLARED it!</p></header></div><div class="longform-layout_container__1bKFt container"><div class="row"><div class="longform-layout_content__gfokN col-lg-8"><article class="longform"><article class="longform"><div><p>Firefly III is a budget management app that I’m trying to self-host. Being a budget management app, it would hold every single monetary transaction I make, which is obviously somewhat sensitive. As such, I’m running it on my local cluster instead of on a public cloud instance that also hosts my website backend.</p>
<h2 id="provisioning-the-server-manually">Provisioning the server manually</h2>
<p>Firefly uses MySQL as its database backend, so I’ve spun up an LXC container built from TurnKeyLinux’s excellent MySQL container image through Proxmox.</p>
<a href="/_/2021/02/13/terraform-mysql-k8s/turnkey-mysql.png"><img src="/_/2021/02/13/terraform-mysql-k8s/turnkey-mysql.png" alt="The downloadable TurnKeyLinux MySQL LXC image" width="1200"/></a>
<a href="/_/2021/02/13/terraform-mysql-k8s/proxmox-container.png"><img src="/_/2021/02/13/terraform-mysql-k8s/proxmox-container.png" alt="The LXC container running." width="1200"/></a>
<p>Unfortunately, I didn’t automate this step; I just manually provisioned it through the web UI like a pleb. However, I will try to automate it using Terraform for my Postgres database, possibly in a later blog post.</p>
<h2 id="provisioning-the-database-automatically">Provisioning the database automatically</h2>
<p>However, once I had that out of the way, I wrote a short Terraform configuration that:</p>
<ol>
<li>Provisions a MySQL database</li>
<li>Provisions a user with an automatically-generated password</li>
<li>Securely creates a secret in Kubernetes to be used in Firefly</li>
</ol>
<h3 id="declaring-plugins-and-providers">Declaring plugins and providers</h3>
<p>First, we declare the plugins we use.</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token property">required_version</span> <span class="token punctuation">=</span> <span class="token string">&quot;&gt;= 0.13.0&quot;</span>

  <span class="token keyword">required_providers</span> <span class="token punctuation">{</span>
    <span class="token property">random</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">&quot;hashicorp/random&quot;</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;&gt;= 2.2.0&quot;</span>
    <span class="token punctuation">}</span>
    <span class="token property">mysql</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">&quot;terraform-providers/mysql&quot;</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;&gt;= 1.5&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>Next, we declare some variables for our MySQL admin parameters.</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">variable<span class="token type variable"> &quot;mysql_host&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">&quot;MySQL server host.&quot;</span>
  <span class="token property">type</span>        <span class="token punctuation">=</span> string
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;mysql_port&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">&quot;MySQL server port.&quot;</span>
  <span class="token property">type</span>        <span class="token punctuation">=</span> string
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;mysql_admin_user&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">&quot;MySQL server administrator&#x27;s username.&quot;</span>
  <span class="token property">type</span>        <span class="token punctuation">=</span> string
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;mysql_admin_password&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">&quot;MySQL server administrator&#x27;s password.&quot;</span>
  <span class="token property">type</span>        <span class="token punctuation">=</span> string
  <span class="token property">sensitive</span>   <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>We can import them in an <code>.env</code> file that looks like this.</p>
<div class="remark-highlight"><pre class="language-sh"><code class="language-sh">export TF_VAR_mysql_host=...
export TF_VAR_mysql_port=...
export TF_VAR_mysql_admin_user=...
export TF_VAR_mysql_admin_password=...</code></pre></div>
<p>Combining all of those variables together, we declare the following MySQL provider:</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">provider<span class="token type variable"> &quot;mysql&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">endpoint</span> <span class="token punctuation">=</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">mysql_host</span><span class="token punctuation">}</span></span>:<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">mysql_port</span><span class="token punctuation">}</span></span>&quot;</span>
  <span class="token property">username</span> <span class="token punctuation">=</span> var.mysql_admin_user
  <span class="token property">password</span> <span class="token punctuation">=</span> var.mysql_admin_password
  <span class="token property">tls</span> <span class="token punctuation">=</span> <span class="token string">&quot;skip-verify&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>Additionally, we declare our Kubernetes provider to allow us to directly insert our passwords into the cluster as a Secret.</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">provider<span class="token type variable"> &quot;kubernetes&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">config_path</span>    <span class="token punctuation">=</span> <span class="token string">&quot;~/.kube/config&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h3 id="declaring-a-database-and-user">Declaring a Database and User</h3>
<p>Declaring a database is as simple as</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">&quot;mysql_database&quot;</span></span> <span class="token string">&quot;firefly&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">&quot;fireflyiii&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>To create our user, however, we need to first generate a password. This creates a 16-char password.</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">&quot;random_password&quot;</span></span> <span class="token string">&quot;firefly_password&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">length</span> <span class="token punctuation">=</span> <span class="token number">16</span>
  <span class="token property">special</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">override_special</span> <span class="token punctuation">=</span> <span class="token string">&quot;_%@&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>With our password, we can create the user.</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">&quot;mysql_user&quot;</span></span> <span class="token string">&quot;firefly&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">user</span> <span class="token punctuation">=</span> <span class="token string">&quot;fireflyop&quot;</span>
  <span class="token property">plaintext_password</span>  <span class="token punctuation">=</span> random_password.firefly_password.result
  <span class="token property">host</span> <span class="token punctuation">=</span> <span class="token string">&quot;192.168.1.%&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>The variable <code>random_password.firefly_password.result</code> is in <code>&lt;provider&gt;.&lt;resource name&gt;.&lt;field name&gt;</code> form.</p>
<p>In order to let our user actually do things, we need to grant them all the privileges on the <code>firefly</code> database.</p>
<p><strong>Warning:</strong> To be honest, I don’t know how to do this the right way. I thought it could do a <code>GRANT ALL ON ...</code> with the following segment of code:</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">&quot;mysql_grant&quot;</span></span> <span class="token string">&quot;firefly&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">user</span> <span class="token punctuation">=</span> mysql_user.firefly.user
  <span class="token property">host</span> <span class="token punctuation">=</span> mysql_user.firefly.host
  <span class="token property">database</span> <span class="token punctuation">=</span> mysql_database.firefly.name
  <span class="token property">privileges</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;ALL&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>but this doesn’t seem to work. I ended up running the Terraform script to provision almost all of the resources, then granting the privileges manually.</p>
<h3 id="giving-kubernetes-the-passwords">Giving Kubernetes the Passwords</h3>
<p>There is one final step that is specific to Firefly III that we must do. Firefly III encrypts its database with a 32-character key, so we need to generate that. I could have done this outside of Terraform, but I thought it would be more convenient to do it inside.</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">&quot;random_password&quot;</span></span> <span class="token string">&quot;firefly_key&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">length</span> <span class="token punctuation">=</span> <span class="token number">32</span>
  <span class="token property">special</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">override_special</span> <span class="token punctuation">=</span> <span class="token string">&quot;_%@{}~`[]()&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>Finally, we can submit all of our secrets to Kubernetes! We do this by taking all of our variables from above and combining it together.</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">resource <span class="token type variable">&quot;kubernetes_secret&quot;</span></span> <span class="token string">&quot;firefly&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">type</span> <span class="token punctuation">=</span> <span class="token string">&quot;Opaque&quot;</span>

  <span class="token keyword">metadata</span> <span class="token punctuation">{</span>
    <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">&quot;firefly-db&quot;</span>
    <span class="token property">namespace</span> <span class="token punctuation">=</span> <span class="token string">&quot;firefly-iii&quot;</span>
  <span class="token punctuation">}</span>

  <span class="token property">data</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;APP_KEY&quot;</span> <span class="token punctuation">=</span> random_password.firefly_key.result
    <span class="token property">&quot;DB_USERNAME&quot;</span> <span class="token punctuation">=</span> mysql_user.firefly.user
    <span class="token property">&quot;DB_PASSWORD&quot;</span> <span class="token punctuation">=</span> random_password.firefly_password.result
    <span class="token property">&quot;DB_HOST&quot;</span> <span class="token punctuation">=</span> var.mysql_host
    <span class="token property">&quot;DB_PORT&quot;</span> <span class="token punctuation">=</span> <span class="token number">3306</span>
    <span class="token property">&quot;DB_DATABASE&quot;</span> <span class="token punctuation">=</span> mysql_database.firefly.name
    <span class="token property">&quot;DB_CONNECTION&quot;</span> <span class="token punctuation">=</span> <span class="token string">&quot;mysql&quot;</span>
    <span class="token property">&quot;MYSQL_USE_SSL&quot;</span> <span class="token punctuation">=</span> <span class="token string">&quot;true&quot;</span>
    <span class="token property">&quot;MYSQL_SSL_VERIFY_SERVER_CERT&quot;</span> <span class="token punctuation">=</span> <span class="token string">&quot;false&quot;</span>
    <span class="token property">&quot;MYSQL_SSL_CAPATH&quot;</span> <span class="token punctuation">=</span> <span class="token string">&quot;/etc/ssl/certs/&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>This creates <code>secret/firefly-db</code> under namespace <code>firefly-iii</code> with all of the parameters that we want.</p>
<h3 id="putting-it-all-together">Putting it all together</h3>
<p>We have a full configuration file now!</p>
<div class="remark-highlight"><pre class="language-hcl"><code class="language-hcl"><span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token property">required_version</span> <span class="token punctuation">=</span> <span class="token string">&quot;&gt;= 0.13.0&quot;</span>

  <span class="token keyword">required_providers</span> <span class="token punctuation">{</span>
    <span class="token property">random</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">&quot;hashicorp/random&quot;</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;&gt;= 2.2.0&quot;</span>
    <span class="token punctuation">}</span>
    <span class="token property">mysql</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span>  <span class="token punctuation">=</span> <span class="token string">&quot;terraform-providers/mysql&quot;</span>
      <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;&gt;= 1.5&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;mysql_host&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">&quot;MySQL server host.&quot;</span>
  <span class="token property">type</span>        <span class="token punctuation">=</span> string
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;mysql_port&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">&quot;MySQL server port.&quot;</span>
  <span class="token property">type</span>        <span class="token punctuation">=</span> string
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;mysql_admin_user&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">&quot;MySQL server administrator&#x27;s username.&quot;</span>
  <span class="token property">type</span>        <span class="token punctuation">=</span> string
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;mysql_admin_password&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">&quot;MySQL server administrator&#x27;s password.&quot;</span>
  <span class="token property">type</span>        <span class="token punctuation">=</span> string
  <span class="token property">sensitive</span>   <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">provider<span class="token type variable"> &quot;mysql&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">endpoint</span> <span class="token punctuation">=</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">mysql_host</span><span class="token punctuation">}</span></span>:<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span><span class="token keyword">var</span><span class="token punctuation">.</span><span class="token type variable">mysql_port</span><span class="token punctuation">}</span></span>&quot;</span>
  <span class="token property">username</span> <span class="token punctuation">=</span> var.mysql_admin_user
  <span class="token property">password</span> <span class="token punctuation">=</span> var.mysql_admin_password
  <span class="token property">tls</span> <span class="token punctuation">=</span> <span class="token string">&quot;skip-verify&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">&quot;mysql_database&quot;</span></span> <span class="token string">&quot;firefly&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">&quot;fireflyiii&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">&quot;random_password&quot;</span></span> <span class="token string">&quot;firefly_password&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">length</span> <span class="token punctuation">=</span> <span class="token number">16</span>
  <span class="token property">special</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">override_special</span> <span class="token punctuation">=</span> <span class="token string">&quot;_%@&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">&quot;mysql_user&quot;</span></span> <span class="token string">&quot;firefly&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">user</span> <span class="token punctuation">=</span> <span class="token string">&quot;fireflyop&quot;</span>
  <span class="token property">plaintext_password</span>  <span class="token punctuation">=</span> random_password.firefly_password.result
  <span class="token property">host</span> <span class="token punctuation">=</span> <span class="token string">&quot;192.168.1.%&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">&quot;mysql_grant&quot;</span></span> <span class="token string">&quot;firefly&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">user</span> <span class="token punctuation">=</span> mysql_user.firefly.user
  <span class="token property">host</span> <span class="token punctuation">=</span> mysql_user.firefly.host
  <span class="token property">database</span> <span class="token punctuation">=</span> mysql_database.firefly.name
  <span class="token property">privileges</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;ALL&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">provider<span class="token type variable"> &quot;kubernetes&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">config_path</span>    <span class="token punctuation">=</span> <span class="token string">&quot;~/.kube/config&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">&quot;random_password&quot;</span></span> <span class="token string">&quot;firefly_key&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">length</span> <span class="token punctuation">=</span> <span class="token number">32</span>
  <span class="token property">special</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
  <span class="token property">override_special</span> <span class="token punctuation">=</span> <span class="token string">&quot;_%@{}~`[]()&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">resource <span class="token type variable">&quot;kubernetes_secret&quot;</span></span> <span class="token string">&quot;firefly&quot;</span> <span class="token punctuation">{</span>
  <span class="token property">type</span> <span class="token punctuation">=</span> <span class="token string">&quot;Opaque&quot;</span>

  <span class="token keyword">metadata</span> <span class="token punctuation">{</span>
    <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">&quot;firefly-db&quot;</span>
    <span class="token property">namespace</span> <span class="token punctuation">=</span> <span class="token string">&quot;firefly-iii&quot;</span>
  <span class="token punctuation">}</span>

  <span class="token property">data</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;APP_KEY&quot;</span> <span class="token punctuation">=</span> random_password.firefly_key.result
    <span class="token property">&quot;DB_USERNAME&quot;</span> <span class="token punctuation">=</span> mysql_user.firefly.user
    <span class="token property">&quot;DB_PASSWORD&quot;</span> <span class="token punctuation">=</span> random_password.firefly_password.result
    <span class="token property">&quot;DB_HOST&quot;</span> <span class="token punctuation">=</span> var.mysql_host
    <span class="token property">&quot;DB_PORT&quot;</span> <span class="token punctuation">=</span> <span class="token number">3306</span>
    <span class="token property">&quot;DB_DATABASE&quot;</span> <span class="token punctuation">=</span> mysql_database.firefly.name
    <span class="token property">&quot;DB_CONNECTION&quot;</span> <span class="token punctuation">=</span> <span class="token string">&quot;mysql&quot;</span>
    <span class="token property">&quot;MYSQL_USE_SSL&quot;</span> <span class="token punctuation">=</span> <span class="token string">&quot;true&quot;</span>
    <span class="token property">&quot;MYSQL_SSL_VERIFY_SERVER_CERT&quot;</span> <span class="token punctuation">=</span> <span class="token string">&quot;false&quot;</span>
    <span class="token property">&quot;MYSQL_SSL_CAPATH&quot;</span> <span class="token punctuation">=</span> <span class="token string">&quot;/etc/ssl/certs/&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>To deploy, it’s as simple as</p>
<div class="remark-highlight"><pre class="language-sh"><code class="language-sh">. ./.env
terraform apply</code></pre></div>
<h2 id="the-kubernetes-app-manifest">The Kubernetes app manifest</h2>
<p>I can declare the Firefly III app as a StatefulSet (stateful because it needs to store some upload data). Inside a single container’s spec, we can apply all of our secrets into its environment variables with a <code>envFrom[].secretRef</code> like so:</p>
<div class="remark-highlight"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app
  <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.hub.docker.com/jc5x/firefly<span class="token punctuation">-</span>iii<span class="token punctuation">:</span>latest
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ
      <span class="token key atrule">value</span><span class="token punctuation">:</span> America/Los_Angeles
  <span class="token key atrule">envFrom</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">secretRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> firefly<span class="token punctuation">-</span>db
  <span class="token punctuation">...</span>
</code></pre></div>
<p>After applying this manifest and its associated service and ingress, everything seems to work!</p>
<a href="/_/2021/02/13/terraform-mysql-k8s/firefly-works.png"><img src="/_/2021/02/13/terraform-mysql-k8s/firefly-works.png" alt="It&#x27;t aliiiiiive!" width="1200"/></a>
<h2 id="what-next">What next?</h2>
<p>While this solution is much nicer and more automated than creating the database manually in a GUI or SQL script, this isn’t the most secure way to provision a user. I heard that Hashicorp Vault can actually generate new passwords specifically for one app on the fly, and I might explore that later.</p></div></article></article></div><div class="col-lg-4"><div class="longform-layout_sidebarGroup__1maJR"><table style="width:100%"><tbody><tr><th style="min-width:180px"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm436-44v-36c0-26.5-21.5-48-48-48h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v36c0 6.6 5.4 12 12 12h424c6.6 0 12-5.4 12-12z"></path></svg> <!-- -->Date</th><td class="longform-layout_statusData__1GlEa">13 Feb 2021</td></tr></tbody></table></div><div class="longform-layout_sidebarGroup__1maJR"><h2>Tags</h2><div><p style="font-size:12pt;margin-bottom:3px"><a href="/projects/plebscale/"><span style="background-color:#86e600;color:#000000;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">/projects/plebscale/</span></a><a href="/t/devops"><span style="background-color:#47e000;color:#000000;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">devops</span></a><a href="/t/kubernetes"><span style="background-color:#0039f5;color:#ffffff;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">kubernetes</span></a><a href="/t/mysql"><span style="background-color:#525569;color:#ffffff;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">MySQL</span></a><a href="/t/proxmox"><span style="background-color:#eb0095;color:#ffffff;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">proxmox</span></a><a href="/t/terraform"><span style="background-color:#0084d1;color:#ffffff;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">terraform</span></a> </p></div></div></div></div></div><div class="container"><section id="comments"><h2>Comments</h2><div class="comments"><div><form class=""><div class="row form-group"><label for="comment-name" class="col-sm-4 col-form-label">Name (leave blank for anonymous)</label><div class="col-sm-8"><input type="text" name="name" id="comment-name" placeholder="Willy Shakespeare" class="form-control"/></div></div><div class="row form-group"><label for="comment-email" class="col-sm-4 col-form-label">Email (required)</label><div class="col-sm-8"><input type="email" name="email" id="comment-email" placeholder="user@example.com" class="form-control"/></div></div><div class="row form-group"><label for="comment-website" class="col-sm-4 col-form-label">Website</label><div class="col-sm-8"><input type="url" name="website" id="comment-website" placeholder="my.cool.site" class="form-control"/></div></div><div class="form-group"><label for="comment-body" class="">Comment (<!-- -->1000<!-- --> chars left)</label><textarea name="body" id="comment-body" placeholder="Type your comment here..." class="form-control"></textarea><small class="form-text text-muted">Markdown formatting is supported.</small></div><div class="row"><button type="button" class="btn btn-primary">Submit!</button></div></form></div></div></section></div></div><footer class="footer_footer__1KZqX"><div class="text-light small container"><div class="col"><nav class="row"><div class="col-6 col-sm-4"><a href="/privacy/">Privacy Policy</a></div><div class="col-6 col-sm-4"><a href="/licenses/">Open Source Licenses</a></div><div class="col-6 col-sm-4"><a href="/about/">About/Contact</a></div></nav></div><div class="col"><p>astrid.tech v<!-- -->2.0.0<!-- --> was created by Astrid Yu with a generous helping of <span title="tea" aria-label="tea" role="img">☕</span> and <span title="witchcraft" aria-label="witchcraft" role="img">🧙‍</span>. See the<!-- --> <a href="/projects/astrid-tech/">self-referential project page</a> <!-- -->or see the code yourself on<!-- --> <a href="https://github.com/astralbijection/astrid.tech">GitHub</a>.</p></div><div class="row"><div class="col"></div></div><div class="row"><div class="text-center col"><a href="https://www.gnu.org/licenses/agpl-3.0.en.html"><img alt="GNU Affero General Public License" width="100" height="40" src="/agpl.png"/></a><p><a href="https://github.com/astralbijection/astrid.tech">The source code of astrid.tech</a> <!-- -->is licensed under the<!-- --> <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">AGPL License</a>.<!-- --> </p></div><div class="text-center col"><p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/></a><br/><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">The page content of astrid.tech</span> <!-- -->by<!-- --> <a xmlns:cc="http://creativecommons.org/ns#" href="https://astrid.tech" property="cc:attributionName" rel="cc:attributionURL">Astrid Yu</a> <!-- -->is licensed under a<!-- --> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":5,"assetRoot":"2021/02/13/terraform-mysql-k8s","thumbnail":null,"title":"Declaratively Provision Databases and Submit Credentials to Kubernetes using Terraform","description":"DATABASES! I didn't say it, I DECLARED it!","slug":"terraform-mysql-k8s","date":"2021-02-13T20:10:50.000Z","content":"\u003cp\u003eFirefly III is a budget management app that I’m trying to self-host. Being a budget management app, it would hold every single monetary transaction I make, which is obviously somewhat sensitive. As such, I’m running it on my local cluster instead of on a public cloud instance that also hosts my website backend.\u003c/p\u003e\n\u003ch2 id=\"provisioning-the-server-manually\"\u003eProvisioning the server manually\u003c/h2\u003e\n\u003cp\u003eFirefly uses MySQL as its database backend, so I’ve spun up an LXC container built from TurnKeyLinux’s excellent MySQL container image through Proxmox.\u003c/p\u003e\n\u003cimg src=\"/_/2021/02/13/terraform-mysql-k8s/turnkey-mysql.png\" alt=\"The downloadable TurnKeyLinux MySQL LXC image\"\u003e\n\u003cimg src=\"/_/2021/02/13/terraform-mysql-k8s/proxmox-container.png\" alt=\"The LXC container running.\"\u003e\n\u003cp\u003eUnfortunately, I didn’t automate this step; I just manually provisioned it through the web UI like a pleb. However, I will try to automate it using Terraform for my Postgres database, possibly in a later blog post.\u003c/p\u003e\n\u003ch2 id=\"provisioning-the-database-automatically\"\u003eProvisioning the database automatically\u003c/h2\u003e\n\u003cp\u003eHowever, once I had that out of the way, I wrote a short Terraform configuration that:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eProvisions a MySQL database\u003c/li\u003e\n\u003cli\u003eProvisions a user with an automatically-generated password\u003c/li\u003e\n\u003cli\u003eSecurely creates a secret in Kubernetes to be used in Firefly\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"declaring-plugins-and-providers\"\u003eDeclaring plugins and providers\u003c/h3\u003e\n\u003cp\u003eFirst, we declare the plugins we use.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003erequired_version\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003e= 0.13.0\"\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003erequired_providers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003erandom\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003esource\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hashicorp/random\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003e= 2.2.0\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emysql\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003esource\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"terraform-providers/mysql\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003e= 1.5\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNext, we declare some variables for our MySQL admin parameters.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"mysql_host\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"MySQL server host.\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"mysql_port\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"MySQL server port.\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"mysql_admin_user\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"MySQL server administrator's username.\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"mysql_admin_password\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"MySQL server administrator's password.\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n  \u003cspan class=\"token property\"\u003esensitive\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWe can import them in an \u003ccode\u003e.env\u003c/code\u003e file that looks like this.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-sh\"\u003e\u003ccode class=\"language-sh\"\u003eexport TF_VAR_mysql_host=...\nexport TF_VAR_mysql_port=...\nexport TF_VAR_mysql_admin_user=...\nexport TF_VAR_mysql_admin_password=...\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eCombining all of those variables together, we declare the following MySQL provider:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"mysql\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eendpoint\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003emysql_host\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e:\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003emysql_port\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eusername\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.mysql_admin_user\n  \u003cspan class=\"token property\"\u003epassword\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.mysql_admin_password\n  \u003cspan class=\"token property\"\u003etls\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"skip-verify\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAdditionally, we declare our Kubernetes provider to allow us to directly insert our passwords into the cluster as a Secret.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"kubernetes\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003econfig_path\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"~/.kube/config\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"declaring-a-database-and-user\"\u003eDeclaring a Database and User\u003c/h3\u003e\n\u003cp\u003eDeclaring a database is as simple as\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"mysql_database\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"fireflyiii\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eTo create our user, however, we need to first generate a password. This creates a 16-char password.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"random_password\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly_password\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003elength\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e16\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003especial\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eoverride_special\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"_%@\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWith our password, we can create the user.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"mysql_user\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003euser\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"fireflyop\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eplaintext_password\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e random_password.firefly_password.result\n  \u003cspan class=\"token property\"\u003ehost\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"192.168.1.%\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe variable \u003ccode\u003erandom_password.firefly_password.result\u003c/code\u003e is in \u003ccode\u003e\u0026#x3C;provider\u003e.\u0026#x3C;resource name\u003e.\u0026#x3C;field name\u003e\u003c/code\u003e form.\u003c/p\u003e\n\u003cp\u003eIn order to let our user actually do things, we need to grant them all the privileges on the \u003ccode\u003efirefly\u003c/code\u003e database.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWarning:\u003c/strong\u003e To be honest, I don’t know how to do this the right way. I thought it could do a \u003ccode\u003eGRANT ALL ON ...\u003c/code\u003e with the following segment of code:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"mysql_grant\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003euser\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e mysql_user.firefly.user\n  \u003cspan class=\"token property\"\u003ehost\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e mysql_user.firefly.host\n  \u003cspan class=\"token property\"\u003edatabase\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e mysql_database.firefly.name\n  \u003cspan class=\"token property\"\u003eprivileges\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ALL\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ebut this doesn’t seem to work. I ended up running the Terraform script to provision almost all of the resources, then granting the privileges manually.\u003c/p\u003e\n\u003ch3 id=\"giving-kubernetes-the-passwords\"\u003eGiving Kubernetes the Passwords\u003c/h3\u003e\n\u003cp\u003eThere is one final step that is specific to Firefly III that we must do. Firefly III encrypts its database with a 32-character key, so we need to generate that. I could have done this outside of Terraform, but I thought it would be more convenient to do it inside.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"random_password\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly_key\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003elength\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e32\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003especial\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eoverride_special\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"_%@{}~`[]()\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eFinally, we can submit all of our secrets to Kubernetes! We do this by taking all of our variables from above and combining it together.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"kubernetes_secret\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Opaque\"\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003emetadata\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly-db\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly-iii\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003edata\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"APP_KEY\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e random_password.firefly_key.result\n    \u003cspan class=\"token property\"\u003e\"DB_USERNAME\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e mysql_user.firefly.user\n    \u003cspan class=\"token property\"\u003e\"DB_PASSWORD\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e random_password.firefly_password.result\n    \u003cspan class=\"token property\"\u003e\"DB_HOST\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.mysql_host\n    \u003cspan class=\"token property\"\u003e\"DB_PORT\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e3306\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"DB_DATABASE\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e mysql_database.firefly.name\n    \u003cspan class=\"token property\"\u003e\"DB_CONNECTION\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"mysql\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"MYSQL_USE_SSL\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"true\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"MYSQL_SSL_VERIFY_SERVER_CERT\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"false\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"MYSQL_SSL_CAPATH\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/etc/ssl/certs/\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis creates \u003ccode\u003esecret/firefly-db\u003c/code\u003e under namespace \u003ccode\u003efirefly-iii\u003c/code\u003e with all of the parameters that we want.\u003c/p\u003e\n\u003ch3 id=\"putting-it-all-together\"\u003ePutting it all together\u003c/h3\u003e\n\u003cp\u003eWe have a full configuration file now!\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-hcl\"\u003e\u003ccode class=\"language-hcl\"\u003e\u003cspan class=\"token keyword\"\u003eterraform\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003erequired_version\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003e= 0.13.0\"\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003erequired_providers\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003erandom\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003esource\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hashicorp/random\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003e= 2.2.0\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003emysql\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003esource\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"terraform-providers/mysql\"\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003e= 1.5\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"mysql_host\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"MySQL server host.\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"mysql_port\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"MySQL server port.\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"mysql_admin_user\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"MySQL server administrator's username.\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evariable\u003cspan class=\"token type variable\"\u003e \"mysql_admin_password\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003edescription\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"MySQL server administrator's password.\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e        \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e string\n  \u003cspan class=\"token property\"\u003esensitive\u003c/span\u003e   \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"mysql\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eendpoint\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003emysql_host\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e:\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e$\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token type variable\"\u003emysql_port\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eusername\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.mysql_admin_user\n  \u003cspan class=\"token property\"\u003epassword\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.mysql_admin_password\n  \u003cspan class=\"token property\"\u003etls\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"skip-verify\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"mysql_database\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"fireflyiii\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"random_password\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly_password\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003elength\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e16\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003especial\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eoverride_special\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"_%@\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"mysql_user\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003euser\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"fireflyop\"\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eplaintext_password\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e random_password.firefly_password.result\n  \u003cspan class=\"token property\"\u003ehost\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"192.168.1.%\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"mysql_grant\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003euser\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e mysql_user.firefly.user\n  \u003cspan class=\"token property\"\u003ehost\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e mysql_user.firefly.host\n  \u003cspan class=\"token property\"\u003edatabase\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e mysql_database.firefly.name\n  \u003cspan class=\"token property\"\u003eprivileges\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ALL\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eprovider\u003cspan class=\"token type variable\"\u003e \"kubernetes\" \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003econfig_path\u003c/span\u003e    \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"~/.kube/config\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"random_password\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly_key\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003elength\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e32\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003especial\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003eoverride_special\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"_%@{}~`[]()\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eresource \u003cspan class=\"token type variable\"\u003e\"kubernetes_secret\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003etype\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Opaque\"\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003emetadata\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly-db\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003enamespace\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"firefly-iii\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token property\"\u003edata\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"APP_KEY\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e random_password.firefly_key.result\n    \u003cspan class=\"token property\"\u003e\"DB_USERNAME\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e mysql_user.firefly.user\n    \u003cspan class=\"token property\"\u003e\"DB_PASSWORD\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e random_password.firefly_password.result\n    \u003cspan class=\"token property\"\u003e\"DB_HOST\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e var.mysql_host\n    \u003cspan class=\"token property\"\u003e\"DB_PORT\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e3306\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"DB_DATABASE\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e mysql_database.firefly.name\n    \u003cspan class=\"token property\"\u003e\"DB_CONNECTION\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"mysql\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"MYSQL_USE_SSL\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"true\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"MYSQL_SSL_VERIFY_SERVER_CERT\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"false\"\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"MYSQL_SSL_CAPATH\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/etc/ssl/certs/\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eTo deploy, it’s as simple as\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-sh\"\u003e\u003ccode class=\"language-sh\"\u003e. ./.env\nterraform apply\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"the-kubernetes-app-manifest\"\u003eThe Kubernetes app manifest\u003c/h2\u003e\n\u003cp\u003eI can declare the Firefly III app as a StatefulSet (stateful because it needs to store some upload data). Inside a single container’s spec, we can apply all of our secrets into its environment variables with a \u003ccode\u003eenvFrom[].secretRef\u003c/code\u003e like so:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e app\n  \u003cspan class=\"token key atrule\"\u003eimage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e registry.hub.docker.com/jc5x/firefly\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003eiii\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003elatest\n  \u003cspan class=\"token key atrule\"\u003eenv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e TZ\n      \u003cspan class=\"token key atrule\"\u003evalue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e America/Los_Angeles\n  \u003cspan class=\"token key atrule\"\u003eenvFrom\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003esecretRef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e firefly\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edb\n  \u003cspan class=\"token punctuation\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAfter applying this manifest and its associated service and ingress, everything seems to work!\u003c/p\u003e\n\u003cimg src=\"/_/2021/02/13/terraform-mysql-k8s/firefly-works.png\" alt=\"It\u0026#x27;t aliiiiiive!\"\u003e\n\u003ch2 id=\"what-next\"\u003eWhat next?\u003c/h2\u003e\n\u003cp\u003eWhile this solution is much nicer and more automated than creating the database manually in a GUI or SQL script, this isn’t the most secure way to provision a user. I heard that Hashicorp Vault can actually generate new passwords specifically for one app on the fly, and I might explore that later.\u003c/p\u003e","tags":["/projects/plebscale/","devops","kubernetes","mysql","proxmox","terraform"]}},"__N_SSG":true},"page":"/[year]/[month]/[day]/[...slug]","query":{"year":"2021","month":"02","day":"13","slug":["terraform-mysql-k8s"]},"buildId":"xu5MpDjzYRyNj4te1Gtrv","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>