<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link title="astrid.tech RSS" rel="alternate" type="application/rss+xml" href="https://astrid.tech/rss.xml"/><link title="astrid.tech Atom" rel="alternate" type="application/atom+xml" href="https://astrid.tech/atom.xml"/><link title="astrid.tech JSON feed" rel="alternate" type="application/feed+json" href="https://astrid.tech/feed.json"/><link href="https://github.com/astralbijection" rel="me authn"/><link href="mailto:astrid@astrid.tech" rel="me"/><title>How to set up Dynamic DNS on FreeIPA for your Kubernetes Cluster | astrid.tech</title><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="description" content="Astrid Yu&#x27;s Website"/><meta name="twitter:card" content="summary"/><meta name="twitter:creator" content="astralbijection"/><meta name="twitter:title" content="How to set up Dynamic DNS on FreeIPA for your Kubernetes Cluster"/><meta name="twitter:description" content="Astrid Yu&#x27;s Website"/><meta property="og:title" content="How to set up Dynamic DNS on FreeIPA for your Kubernetes Cluster"/><meta property="og:description" content="Astrid Yu&#x27;s Website"/><meta property="og:type" content="website"/><meta name="robots" content="follow,index"/><meta property="og:url" content="https:/astrid.tech/2021/04/18/k8s-freeipa-dns"/><link title="astrid.tech RSS" rel="alternate" type="application/rss+xml" href="https://astrid.tech/rss.xml"/><link title="astrid.tech Atom" rel="alternate" type="application/atom+xml" href="https://astrid.tech/atom.xml"/><link title="astrid.tech JSON feed" rel="alternate" type="application/feed+json" href="https://astrid.tech/feed.json"/><link href="https://github.com/astralbijection" rel="me authn"/><link href="mailto:astrid@astrid.tech" rel="me"/><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/1d0d198a1c5bdedcad14.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1d0d198a1c5bdedcad14.css" data-n-g=""/><link rel="preload" href="/_next/static/css/bd89e56ee668535d8996.css" as="style"/><link rel="stylesheet" href="/_next/static/css/bd89e56ee668535d8996.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-e7a279300235e161e32a.js"></script><script src="/_next/static/chunks/webpack-3071412ed8bc8fc49fc7.js" defer=""></script><script src="/_next/static/chunks/framework-2f612445bd50b211f15a.js" defer=""></script><script src="/_next/static/chunks/main-6bd02c179f9e0ec2bd5a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-1658794de36b29c002aa.js" defer=""></script><script src="/_next/static/chunks/545f34e4-37710c009d2bbbd273c3.js" defer=""></script><script src="/_next/static/chunks/0c428ae2-571001351e1ed221a25c.js" defer=""></script><script src="/_next/static/chunks/1bfc9850-fc4f6c929a53a9b582f6.js" defer=""></script><script src="/_next/static/chunks/398-1b9f48eb99654eeda62b.js" defer=""></script><script src="/_next/static/chunks/264-b52c4cdeb9e69930784f.js" defer=""></script><script src="/_next/static/chunks/146-41f4f1c63257555b1b33.js" defer=""></script><script src="/_next/static/chunks/993-2df73c7cf8296f032349.js" defer=""></script><script src="/_next/static/chunks/705-c9d82552f3ea55b2fe7a.js" defer=""></script><script src="/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bday%5D/%5B...slug%5D-e11dd750811444406993.js" defer=""></script><script src="/_next/static/xu5MpDjzYRyNj4te1Gtrv/_buildManifest.js" defer=""></script><script src="/_next/static/xu5MpDjzYRyNj4te1Gtrv/_ssgManifest.js" defer=""></script></head><body><div id="__next"><nav class="main-navbar navbar navbar-expand-md fixed-top"><a href="/" class="nav-link navbar-brand">astrid.tech</a><button aria-label="Toggle navigation" type="button" class="navbar-toggler"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M250.97 29.357c-106.557-.21-211.806 52.74-203.48 164.053 138.91 11.4 276.71 8.893 414.174.662 10.58-107.69-100.753-164.498-210.693-164.715zm59.876 23.996c11.165 0 20.216 4.468 20.216 9.98 0 5.513-9.051 9.981-20.216 9.981-11.166 0-20.217-4.468-20.217-9.98 0-5.513 9.051-9.98 20.217-9.98zm-111.852 19.83c11.165 0 20.217 4.469 20.217 9.98 0 5.513-9.052 9.981-20.217 9.981s-20.216-4.468-20.217-9.98c0-5.512 9.052-9.98 20.217-9.98zm178.057 34.02c11.165 0 20.216 4.468 20.217 9.98 0 5.512-9.052 9.98-20.217 9.98s-20.217-4.468-20.217-9.98c0-5.512 9.052-9.98 20.217-9.98zm-273.59 21.535c11.165 0 20.216 4.468 20.217 9.98 0 5.513-9.052 9.98-20.217 9.98s-20.217-4.467-20.217-9.98c0-5.512 9.052-9.98 20.217-9.98zm313.77 30.043c11.165 0 20.216 4.468 20.216 9.98 0 5.512-9.051 9.98-20.217 9.98-11.165 0-20.216-4.468-20.216-9.98 0-5.512 9.051-9.98 20.216-9.98zm-137.91 8.045c11.166 0 20.218 4.47 20.216 9.982 0 5.512-9.051 9.98-20.217 9.98-11.165 0-20.216-4.468-20.216-9.98-.002-5.513 9.05-9.982 20.216-9.982zM57.618 212.339c-18.964.405-9.028 24.485 14.383 24.573 128.554 10.208 236.673 9.686 372.117-2.42 16.096-2.708 25.212-13.087 10.824-21.969-131.579 7.67-263.81 10.045-397.324-.184zm403.024 40.612c-131.224 13.6-277.594 10.525-390.065 1.904-46.983-6.226-47.875 46.785-17.014 52.309 146.18 14.663 271.826 10.735 415.137-.53 25.007-1.144 14.554-55.328-8.058-53.683zM20.986 366.679l15.332 9.434c6.342-8.416 17.876-32.05 33.319-32.192 19.122-.174 22.345 39.302 41.98 39.103 22.607-.228 37.828-31.548 52.447-30.882 22.09 1.008 26.333 35.9 43.557 35.928 24.089.04 31.439-36.39 46.805-35.334 21.458 1.475 33.246 28.274 50.879 29.178 19.004.974 30.654-33.027 43.265-32.748 16.61.366 28.31 32.46 54.24 33.193 15.345.434 29.694-37.411 37.005-36.815 14.417 1.174 26.549 20.548 36.085 34.835l15.114-9.776c-12.029-16.216-30.117-44.428-52.558-44.017-20.907.382-25.948 38.114-38.102 37.943-23.28-.328-33.756-32.164-52.598-33.346-19.356-1.214-30.475 33.636-43.353 32.768-18.954-1.277-27.303-29.16-49.475-29.917-19.62-.67-34.121 37.669-46.793 36.044-18.139-2.326-20.226-36.378-43.317-37.836-19.11-1.207-37.562 30.604-50.314 29.999-17.525-.833-25.243-40.224-45.41-39.986-21.826.258-39.145 30.34-48.108 44.424zm47.553 36.174c-8.342.686-18.198 4.251-21.85 12.424-2.452 6.662 19.173 8.558 21.114 8.695 128.615 8.104 254.354 8.26 389.8-1.345 9.225-.655 13.935-3.147 15.252-4.414 3.124-8.208-23.168-13.935-25.818-14.004-185.01-1.178-279.257 2.209-378.498-1.356zm395.555 37.192c-126.786 6.957-283.18 9.384-408.123.707l.521 38.67c135.917 4.617 275.647 3.99 406.658-.088z"></path></svg></button><div class="collapse navbar-collapse"><a class="nav-link" href="/projects/">Projects</a><a class="nav-link active" href="/latest/">Blog</a><div class="navbar-separator"></div><a class="nav-link" href="/about/">About</a></div></nav><div class="root-wrapper expand-height"><div class="text-light large" style="background-color:black;margin:0;padding:15px;padding-left:30px;padding-right:30px"><p style="text-align:center;margin:0"><b>Black Lives Matter.</b> Please consider donating to the<!-- --> <a href="https://www.paypal.me/SLOBailFund">San Luis Obispo, CA Bail Fund</a> <!-- -->or <a href="https://bailfunds.github.io">other bail funds</a> so we can make the world a just and equitable place for all people of all colors.</p></div><div style="background-color:#e6b3e0"><nav class="page-heading_above__2RV0m"></nav><header class="page-heading_header__zwjn1"><h1>How to set up Dynamic DNS on FreeIPA for your Kubernetes Cluster</h1></header></div><div class="longform-layout_container__1bKFt container"><div class="row"><div class="longform-layout_content__gfokN col-lg-8"><article class="longform"><article class="longform"><div><p>I have a <a href="https://www.freeipa.org/page/Main_Page">FreeIPA</a> server that serves DNS on my home network. I wanted to automatically configure it with my Kubernetes ingresses using <a href="https://github.com/kubernetes-sigs/external-dns">ExternalDNS</a>. There doesn’t seem to be much documentation for this specific setup, so I thought to put together this guide!</p>
<h2 id="requirements">Requirements</h2>
<p>This guide will assume that you have the following set up already:</p>
<ul>
<li>A Kubernetes cluster running on your network</li>
<li>A FreeIPA server (let’s say <code>ipa0.p.astrid.tech</code>) serving DNS for a certain zone you want as the domain suffixes (call it <code>s.astrid.tech</code>)</li>
<li>An app (or apps) on the Kubernetes cluster exposed on an Ingress (we’ll assume it’s <code>firefly.s.astrid.tech</code>)</li>
</ul>
<p>In addition, I used the following guides to assemble this guide:</p>
<ul>
<li><a href="https://www.freeipa.org/page/Howto/ISC_DHCPd_and_Dynamic_DNS_update">FreeIPA - Howto/ISC DHCPd and Dynamic DNS update</a></li>
<li><a href="https://www.freeipa.org/page/Howto/DNS_updates_and_zone_transfers_with_TSIG">FreeIPA - Howto/DNS updates and zone transfers with TSIG</a></li>
<li><a href="https://flylib.com/books/en/2.684.1/allowing_dynamic_updates.html">Flylib.com - Allowing Dynamic Updates</a></li>
<li><a href="https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/rfc2136.md">ExternalDNS - Configuring RFC2136 provider</a></li>
<li><a href="https://github.com/bitnami/charts/tree/master/bitnami/external-dns">bitnami/external-dns Helm chart</a></li>
</ul>
<h2 id="1-generate-a-tsig-key-and-register-it">1. Generate a TSIG key and register it</h2>
<p>We will need to generate a TSIG key first.</p>
<p>Choose a name for your key. I called mine <code>k8s</code> but we’ll call it <code>keyname</code>. Then on your FreeIPA server, execute</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">$ dnssec-keygen -a HMAC-SHA512 -b <span class="token number">512</span> -n HOST keyname
</code></pre></div>
<p>and you will get 2 files in your working directory that are probably called something like <code>Kkeyname.+165+44840.key</code> and <code>Kkeyname.+165+44840.private</code>. Open up the <code>.private</code> one:</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">$ cat Kkeyname.+165+44840.private
Private-key-format: v1.3
Algorithm: 165 (HMAC_SHA512)
Key: zeOLcYcv/95yZX1KSLDreZyMtAsy5Ci5xwC9gW7XAgtOnOTIJpyr03CNDA8sUxfrkhb6Hjs90d3zRGm2g0XDaQ==
Bits: AAA=
Created: 20210418040622
Publish: 20210418040622
Activate: 20210418040622</code></pre></div>
<p>and copy the part after <code>Key:</code>.</p>
<p>Finally, add the following to your <code>/etc/named.conf</code>, but substitute the key for your key:</p>
<div class="remark-highlight"><pre class="language-conf"><code class="language-conf">key &amp;quot;keyname&amp;quot; {
       algorithm hmac-sha512;
       secret &amp;quot;zeOLcYcv/95yZX1KSLDreZyMtAsy5Ci5xwC9gW7XAgtOnOTIJpyr03CNDA8sUxfrkhb6Hjs90d3zRGm2g0XDaQ==&amp;quot;;
};</code></pre></div>
<p>Repeat this for every FreeIPA server you have, and we can move onto the next step.</p>
<h2 id="2-enable-ddns-on-your-freeipa-server">2. Enable DDNS on your FreeIPA server</h2>
<p>This step can be done via UI or CLI, but I did it via UI.</p>
<p>First, navigate to your DNS zone’s settings page.</p>
<a href="/_/2021/04/17/0/dns-settings.png"><img src="/_/2021/04/17/0/dns-settings.png" alt="How the top of your UI should look" width="1200"/></a>
<p>Scroll down to where it says “Dynamic update” and set that to True. Additionally, add the following line<sup id="fnref-guide-dev-1"><a href="#fn-guide-dev-1" class="footnote-ref">guide-dev-1</a></sup> to “BIND update policy,” replacing <code>keyname</code> with your key and <code>s.astrid.tech</code> with your zone:</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">grant keyname subdomain s.astrid.tech ANY;</code></pre></div>
<p>Now, your UI should look something like this:</p>
<a href="/_/2021/04/17/0/ddns-and-bind-update-policy.png"><img src="/_/2021/04/17/0/ddns-and-bind-update-policy.png" alt="How your UI should look after making these changes" width="1200"/></a>
<p>Save your changes, and anyone with that secret key can add anything to that subdomain.</p>
<h2 id="3-install-externaldns-on-your-kubernetes-cluster">3. Install ExternalDNS on your Kubernetes cluster</h2>
<p><a href="https://github.com/kubernetes-sigs/external-dns">ExternalDNS</a> is an addon for Kubernetes that has functionality to provide DNS updates over RFC2136. I installed the <a href="https://github.com/bitnami/charts/tree/master/bitnami/external-dns">bitnami/external-dns Helm chart</a> using the following <a href="https://github.com/roboll/helmfile">Helmfile</a>:</p>
<div class="remark-highlight"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">repositories</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> bitnami
    <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//charts.bitnami.com/bitnami
<span class="token key atrule">releases</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> freeipa<span class="token punctuation">-</span>dns<span class="token punctuation">-</span>sync
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>dns
    <span class="token key atrule">chart</span><span class="token punctuation">:</span> bitnami/external<span class="token punctuation">-</span>dns
    <span class="token key atrule">installed</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">values</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">provider</span><span class="token punctuation">:</span> rfc2136
        <span class="token key atrule">logFormat</span><span class="token punctuation">:</span> json
        <span class="token key atrule">domainFilters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> s.astrid.tech <span class="token comment"># only handle DDNS for *.s.astrid.tech domains</span>
        <span class="token key atrule">rfc2136</span><span class="token punctuation">:</span>
          <span class="token key atrule">host</span><span class="token punctuation">:</span> ipa0.p.astrid.tech <span class="token comment"># replace with your host</span>
          <span class="token key atrule">zone</span><span class="token punctuation">:</span> s.astrid.tech <span class="token comment"># replace with your zone</span>
          <span class="token key atrule">tsigKeyname</span><span class="token punctuation">:</span> keyname <span class="token comment"># replace with your keyname</span>
          <span class="token key atrule">tsigSecretAlg</span><span class="token punctuation">:</span> hmac<span class="token punctuation">-</span>sha512
          <span class="token key atrule">secretName</span><span class="token punctuation">:</span> freeipa<span class="token punctuation">-</span>rfc2136
</code></pre></div>
<p>After deploying this with <code>helmfile apply</code>, I then installed the following secret:</p>
<div class="remark-highlight"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> freeipa<span class="token punctuation">-</span>rfc2136
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>dns
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">stringData</span><span class="token punctuation">:</span>
  <span class="token comment"># replace with your secret</span>
  <span class="token key atrule">rfc2136_tsig_secret</span><span class="token punctuation">:</span> zeOLcYcv/95yZX1KSLDreZyMtAsy5Ci5xwC9gW7XAgtOnOTIJpyr03CNDA8sUxfrkhb6Hjs90d3zRGm2g0XDaQ==
</code></pre></div>
<p>And that’s it! You should soon see DNS records show up in FreeIPA automatically.</p>
<a href="/_/2021/04/17/0/dns-complete.png"><img src="/_/2021/04/17/0/dns-complete.png" alt="FreeIPA DNS, but with automatically updated DNS settings" width="1200"/></a>
<p>For debugging, you may want to check external DNS’s logs using <code>kubectl logs [podname]</code>.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn-guide-dev-1">Note that this is a deviation from <a href="https://www.freeipa.org/page/Howto/DNS_updates_and_zone_transfers_with_TSIG">this guide</a>, where it says to write <code>grant keyname name s.astrid.tech ANY;</code>. <code>name</code> only allows you to change <code>s.astrid.tech</code>, while <code>subdomain</code> allows you to change every domain like <code>*.s.astrid.tech</code>, as described <a href="https://flylib.com/books/en/2.684.1/allowing_dynamic_updates.html">here</a>.<a href="#fnref-guide-dev-1" class="footnote-backref">↩</a></li>
</ol>
</div></div></article></article></div><div class="col-lg-4"><div class="longform-layout_sidebarGroup__1maJR"><table style="width:100%"><tbody><tr><th style="min-width:180px"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm436-44v-36c0-26.5-21.5-48-48-48h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v36c0 6.6 5.4 12 12 12h424c6.6 0 12-5.4 12-12z"></path></svg> <!-- -->Date</th><td class="longform-layout_statusData__1GlEa">18 Apr 2021</td></tr></tbody></table></div><div class="longform-layout_sidebarGroup__1maJR"><h2>Tags</h2><div><p style="font-size:12pt;margin-bottom:3px"><a href="/t/devops"><span style="background-color:#47e000;color:#000000;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">devops</span></a><a href="/t/dns"><span style="background-color:#29f4ff;color:#000000;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">dns</span></a><a href="/t/freeipa"><span style="background-color:#9e004c;color:#ffffff;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">freeipa</span></a><a href="/t/kubernetes"><span style="background-color:#0039f5;color:#ffffff;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">kubernetes</span></a> </p></div></div></div></div></div><div class="container"><section id="comments"><h2>Comments</h2><div class="comments"><div><form class=""><div class="row form-group"><label for="comment-name" class="col-sm-4 col-form-label">Name (leave blank for anonymous)</label><div class="col-sm-8"><input type="text" name="name" id="comment-name" placeholder="Willy Shakespeare" class="form-control"/></div></div><div class="row form-group"><label for="comment-email" class="col-sm-4 col-form-label">Email (required)</label><div class="col-sm-8"><input type="email" name="email" id="comment-email" placeholder="user@example.com" class="form-control"/></div></div><div class="row form-group"><label for="comment-website" class="col-sm-4 col-form-label">Website</label><div class="col-sm-8"><input type="url" name="website" id="comment-website" placeholder="my.cool.site" class="form-control"/></div></div><div class="form-group"><label for="comment-body" class="">Comment (<!-- -->1000<!-- --> chars left)</label><textarea name="body" id="comment-body" placeholder="Type your comment here..." class="form-control"></textarea><small class="form-text text-muted">Markdown formatting is supported.</small></div><div class="row"><button type="button" class="btn btn-primary">Submit!</button></div></form></div></div></section></div></div><footer class="footer_footer__1KZqX"><div class="text-light small container"><div class="col"><nav class="row"><div class="col-6 col-sm-4"><a href="/privacy/">Privacy Policy</a></div><div class="col-6 col-sm-4"><a href="/licenses/">Open Source Licenses</a></div><div class="col-6 col-sm-4"><a href="/about/">About/Contact</a></div></nav></div><div class="col"><p>astrid.tech v<!-- -->2.0.0<!-- --> was created by Astrid Yu with a generous helping of <span title="tea" aria-label="tea" role="img">☕</span> and <span title="witchcraft" aria-label="witchcraft" role="img">🧙‍</span>. See the<!-- --> <a href="/projects/astrid-tech/">self-referential project page</a> <!-- -->or see the code yourself on<!-- --> <a href="https://github.com/astralbijection/astrid.tech">GitHub</a>.</p></div><div class="row"><div class="col"></div></div><div class="row"><div class="text-center col"><a href="https://www.gnu.org/licenses/agpl-3.0.en.html"><img alt="GNU Affero General Public License" width="100" height="40" src="/agpl.png"/></a><p><a href="https://github.com/astralbijection/astrid.tech">The source code of astrid.tech</a> <!-- -->is licensed under the<!-- --> <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">AGPL License</a>.<!-- --> </p></div><div class="text-center col"><p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/></a><br/><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">The page content of astrid.tech</span> <!-- -->by<!-- --> <a xmlns:cc="http://creativecommons.org/ns#" href="https://astrid.tech" property="cc:attributionName" rel="cc:attributionURL">Astrid Yu</a> <!-- -->is licensed under a<!-- --> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":2,"assetRoot":"2021/04/17/0","thumbnail":null,"title":"How to set up Dynamic DNS on FreeIPA for your Kubernetes Cluster","description":null,"slug":"k8s-freeipa-dns","date":"2021-04-18T20:35:45.000Z","content":"\u003cp\u003eI have a \u003ca href=\"https://www.freeipa.org/page/Main_Page\"\u003eFreeIPA\u003c/a\u003e server that serves DNS on my home network. I wanted to automatically configure it with my Kubernetes ingresses using \u003ca href=\"https://github.com/kubernetes-sigs/external-dns\"\u003eExternalDNS\u003c/a\u003e. There doesn’t seem to be much documentation for this specific setup, so I thought to put together this guide!\u003c/p\u003e\n\u003ch2 id=\"requirements\"\u003eRequirements\u003c/h2\u003e\n\u003cp\u003eThis guide will assume that you have the following set up already:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eA Kubernetes cluster running on your network\u003c/li\u003e\n\u003cli\u003eA FreeIPA server (let’s say \u003ccode\u003eipa0.p.astrid.tech\u003c/code\u003e) serving DNS for a certain zone you want as the domain suffixes (call it \u003ccode\u003es.astrid.tech\u003c/code\u003e)\u003c/li\u003e\n\u003cli\u003eAn app (or apps) on the Kubernetes cluster exposed on an Ingress (we’ll assume it’s \u003ccode\u003efirefly.s.astrid.tech\u003c/code\u003e)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eIn addition, I used the following guides to assemble this guide:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.freeipa.org/page/Howto/ISC_DHCPd_and_Dynamic_DNS_update\"\u003eFreeIPA - Howto/ISC DHCPd and Dynamic DNS update\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.freeipa.org/page/Howto/DNS_updates_and_zone_transfers_with_TSIG\"\u003eFreeIPA - Howto/DNS updates and zone transfers with TSIG\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://flylib.com/books/en/2.684.1/allowing_dynamic_updates.html\"\u003eFlylib.com - Allowing Dynamic Updates\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/rfc2136.md\"\u003eExternalDNS - Configuring RFC2136 provider\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/bitnami/charts/tree/master/bitnami/external-dns\"\u003ebitnami/external-dns Helm chart\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"1-generate-a-tsig-key-and-register-it\"\u003e1. Generate a TSIG key and register it\u003c/h2\u003e\n\u003cp\u003eWe will need to generate a TSIG key first.\u003c/p\u003e\n\u003cp\u003eChoose a name for your key. I called mine \u003ccode\u003ek8s\u003c/code\u003e but we’ll call it \u003ccode\u003ekeyname\u003c/code\u003e. Then on your FreeIPA server, execute\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$ dnssec-keygen -a HMAC-SHA512 -b \u003cspan class=\"token number\"\u003e512\u003c/span\u003e -n HOST keyname\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eand you will get 2 files in your working directory that are probably called something like \u003ccode\u003eKkeyname.+165+44840.key\u003c/code\u003e and \u003ccode\u003eKkeyname.+165+44840.private\u003c/code\u003e. Open up the \u003ccode\u003e.private\u003c/code\u003e one:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e$ cat Kkeyname.+165+44840.private\nPrivate-key-format: v1.3\nAlgorithm: 165 (HMAC_SHA512)\nKey: zeOLcYcv/95yZX1KSLDreZyMtAsy5Ci5xwC9gW7XAgtOnOTIJpyr03CNDA8sUxfrkhb6Hjs90d3zRGm2g0XDaQ==\nBits: AAA=\nCreated: 20210418040622\nPublish: 20210418040622\nActivate: 20210418040622\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eand copy the part after \u003ccode\u003eKey:\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eFinally, add the following to your \u003ccode\u003e/etc/named.conf\u003c/code\u003e, but substitute the key for your key:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-conf\"\u003e\u003ccode class=\"language-conf\"\u003ekey \u0026#x26;quot;keyname\u0026#x26;quot; {\n       algorithm hmac-sha512;\n       secret \u0026#x26;quot;zeOLcYcv/95yZX1KSLDreZyMtAsy5Ci5xwC9gW7XAgtOnOTIJpyr03CNDA8sUxfrkhb6Hjs90d3zRGm2g0XDaQ==\u0026#x26;quot;;\n};\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eRepeat this for every FreeIPA server you have, and we can move onto the next step.\u003c/p\u003e\n\u003ch2 id=\"2-enable-ddns-on-your-freeipa-server\"\u003e2. Enable DDNS on your FreeIPA server\u003c/h2\u003e\n\u003cp\u003eThis step can be done via UI or CLI, but I did it via UI.\u003c/p\u003e\n\u003cp\u003eFirst, navigate to your DNS zone’s settings page.\u003c/p\u003e\n\u003cimg src=\"/_/2021/04/17/0/dns-settings.png\" alt=\"How the top of your UI should look\"\u003e\n\u003cp\u003eScroll down to where it says “Dynamic update” and set that to True. Additionally, add the following line\u003csup id=\"fnref-guide-dev-1\"\u003e\u003ca href=\"#fn-guide-dev-1\" class=\"footnote-ref\"\u003eguide-dev-1\u003c/a\u003e\u003c/sup\u003e to “BIND update policy,” replacing \u003ccode\u003ekeyname\u003c/code\u003e with your key and \u003ccode\u003es.astrid.tech\u003c/code\u003e with your zone:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003egrant keyname subdomain s.astrid.tech ANY;\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow, your UI should look something like this:\u003c/p\u003e\n\u003cimg src=\"/_/2021/04/17/0/ddns-and-bind-update-policy.png\" alt=\"How your UI should look after making these changes\"\u003e\n\u003cp\u003eSave your changes, and anyone with that secret key can add anything to that subdomain.\u003c/p\u003e\n\u003ch2 id=\"3-install-externaldns-on-your-kubernetes-cluster\"\u003e3. Install ExternalDNS on your Kubernetes cluster\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/kubernetes-sigs/external-dns\"\u003eExternalDNS\u003c/a\u003e is an addon for Kubernetes that has functionality to provide DNS updates over RFC2136. I installed the \u003ca href=\"https://github.com/bitnami/charts/tree/master/bitnami/external-dns\"\u003ebitnami/external-dns Helm chart\u003c/a\u003e using the following \u003ca href=\"https://github.com/roboll/helmfile\"\u003eHelmfile\u003c/a\u003e:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token key atrule\"\u003erepositories\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e bitnami\n    \u003cspan class=\"token key atrule\"\u003eurl\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e https\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e//charts.bitnami.com/bitnami\n\u003cspan class=\"token key atrule\"\u003ereleases\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e freeipa\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edns\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003esync\n    \u003cspan class=\"token key atrule\"\u003enamespace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e external\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edns\n    \u003cspan class=\"token key atrule\"\u003echart\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e bitnami/external\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edns\n    \u003cspan class=\"token key atrule\"\u003einstalled\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean important\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003evalues\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003eprovider\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e rfc2136\n        \u003cspan class=\"token key atrule\"\u003elogFormat\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e json\n        \u003cspan class=\"token key atrule\"\u003edomainFilters\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e s.astrid.tech \u003cspan class=\"token comment\"\u003e# only handle DDNS for *.s.astrid.tech domains\u003c/span\u003e\n        \u003cspan class=\"token key atrule\"\u003erfc2136\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"token key atrule\"\u003ehost\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ipa0.p.astrid.tech \u003cspan class=\"token comment\"\u003e# replace with your host\u003c/span\u003e\n          \u003cspan class=\"token key atrule\"\u003ezone\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e s.astrid.tech \u003cspan class=\"token comment\"\u003e# replace with your zone\u003c/span\u003e\n          \u003cspan class=\"token key atrule\"\u003etsigKeyname\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e keyname \u003cspan class=\"token comment\"\u003e# replace with your keyname\u003c/span\u003e\n          \u003cspan class=\"token key atrule\"\u003etsigSecretAlg\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e hmac\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003esha512\n          \u003cspan class=\"token key atrule\"\u003esecretName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e freeipa\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003erfc2136\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAfter deploying this with \u003ccode\u003ehelmfile apply\u003c/code\u003e, I then installed the following secret:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token key atrule\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e v1\n\u003cspan class=\"token key atrule\"\u003ekind\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Secret\n\u003cspan class=\"token key atrule\"\u003emetadata\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e freeipa\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003erfc2136\n  \u003cspan class=\"token key atrule\"\u003enamespace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e external\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edns\n\u003cspan class=\"token key atrule\"\u003etype\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Opaque\n\u003cspan class=\"token key atrule\"\u003estringData\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e# replace with your secret\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003erfc2136_tsig_secret\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e zeOLcYcv/95yZX1KSLDreZyMtAsy5Ci5xwC9gW7XAgtOnOTIJpyr03CNDA8sUxfrkhb6Hjs90d3zRGm2g0XDaQ==\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnd that’s it! You should soon see DNS records show up in FreeIPA automatically.\u003c/p\u003e\n\u003cimg src=\"/_/2021/04/17/0/dns-complete.png\" alt=\"FreeIPA DNS, but with automatically updated DNS settings\"\u003e\n\u003cp\u003eFor debugging, you may want to check external DNS’s logs using \u003ccode\u003ekubectl logs [podname]\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\u003cli id=\"fn-guide-dev-1\"\u003eNote that this is a deviation from \u003ca href=\"https://www.freeipa.org/page/Howto/DNS_updates_and_zone_transfers_with_TSIG\"\u003ethis guide\u003c/a\u003e, where it says to write \u003ccode\u003egrant keyname name s.astrid.tech ANY;\u003c/code\u003e. \u003ccode\u003ename\u003c/code\u003e only allows you to change \u003ccode\u003es.astrid.tech\u003c/code\u003e, while \u003ccode\u003esubdomain\u003c/code\u003e allows you to change every domain like \u003ccode\u003e*.s.astrid.tech\u003c/code\u003e, as described \u003ca href=\"https://flylib.com/books/en/2.684.1/allowing_dynamic_updates.html\"\u003ehere\u003c/a\u003e.\u003ca href=\"#fnref-guide-dev-1\" class=\"footnote-backref\"\u003e↩\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/div\u003e","tags":["devops","dns","freeipa","kubernetes"]}},"__N_SSG":true},"page":"/[year]/[month]/[day]/[...slug]","query":{"year":"2021","month":"04","day":"18","slug":["k8s-freeipa-dns"]},"buildId":"xu5MpDjzYRyNj4te1Gtrv","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>