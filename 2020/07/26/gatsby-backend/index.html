<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link title="astrid.tech RSS" rel="alternate" type="application/rss+xml" href="https://astrid.tech/rss.xml"/><link title="astrid.tech Atom" rel="alternate" type="application/atom+xml" href="https://astrid.tech/atom.xml"/><link title="astrid.tech JSON feed" rel="alternate" type="application/feed+json" href="https://astrid.tech/feed.json"/><link href="https://github.com/astralbijection" rel="me authn"/><link href="mailto:astrid@astrid.tech" rel="me"/><title>An overview of the new Gatsby backend | astrid.tech</title><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="description" content="Come on in, there&#x27;s digraphs in here"/><meta name="twitter:card" content="summary"/><meta name="twitter:creator" content="astralbijection"/><meta name="twitter:title" content="An overview of the new Gatsby backend"/><meta name="twitter:description" content="Come on in, there&#x27;s digraphs in here"/><meta property="og:title" content="An overview of the new Gatsby backend"/><meta property="og:description" content="Come on in, there&#x27;s digraphs in here"/><meta property="og:type" content="website"/><meta name="robots" content="follow,index"/><meta property="og:url" content="https:/astrid.tech/2020/07/26/gatsby-backend"/><link title="astrid.tech RSS" rel="alternate" type="application/rss+xml" href="https://astrid.tech/rss.xml"/><link title="astrid.tech Atom" rel="alternate" type="application/atom+xml" href="https://astrid.tech/atom.xml"/><link title="astrid.tech JSON feed" rel="alternate" type="application/feed+json" href="https://astrid.tech/feed.json"/><link href="https://github.com/astralbijection" rel="me authn"/><link href="mailto:astrid@astrid.tech" rel="me"/><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/1d0d198a1c5bdedcad14.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1d0d198a1c5bdedcad14.css" data-n-g=""/><link rel="preload" href="/_next/static/css/bd89e56ee668535d8996.css" as="style"/><link rel="stylesheet" href="/_next/static/css/bd89e56ee668535d8996.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-e7a279300235e161e32a.js"></script><script src="/_next/static/chunks/webpack-3071412ed8bc8fc49fc7.js" defer=""></script><script src="/_next/static/chunks/framework-2f612445bd50b211f15a.js" defer=""></script><script src="/_next/static/chunks/main-6bd02c179f9e0ec2bd5a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-1658794de36b29c002aa.js" defer=""></script><script src="/_next/static/chunks/545f34e4-37710c009d2bbbd273c3.js" defer=""></script><script src="/_next/static/chunks/0c428ae2-571001351e1ed221a25c.js" defer=""></script><script src="/_next/static/chunks/1bfc9850-fc4f6c929a53a9b582f6.js" defer=""></script><script src="/_next/static/chunks/398-1b9f48eb99654eeda62b.js" defer=""></script><script src="/_next/static/chunks/264-b52c4cdeb9e69930784f.js" defer=""></script><script src="/_next/static/chunks/146-41f4f1c63257555b1b33.js" defer=""></script><script src="/_next/static/chunks/993-2df73c7cf8296f032349.js" defer=""></script><script src="/_next/static/chunks/705-c9d82552f3ea55b2fe7a.js" defer=""></script><script src="/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bday%5D/%5B...slug%5D-e11dd750811444406993.js" defer=""></script><script src="/_next/static/xu5MpDjzYRyNj4te1Gtrv/_buildManifest.js" defer=""></script><script src="/_next/static/xu5MpDjzYRyNj4te1Gtrv/_ssgManifest.js" defer=""></script></head><body><div id="__next"><nav class="main-navbar navbar navbar-expand-md fixed-top"><a href="/" class="nav-link navbar-brand">astrid.tech</a><button aria-label="Toggle navigation" type="button" class="navbar-toggler"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M250.97 29.357c-106.557-.21-211.806 52.74-203.48 164.053 138.91 11.4 276.71 8.893 414.174.662 10.58-107.69-100.753-164.498-210.693-164.715zm59.876 23.996c11.165 0 20.216 4.468 20.216 9.98 0 5.513-9.051 9.981-20.216 9.981-11.166 0-20.217-4.468-20.217-9.98 0-5.513 9.051-9.98 20.217-9.98zm-111.852 19.83c11.165 0 20.217 4.469 20.217 9.98 0 5.513-9.052 9.981-20.217 9.981s-20.216-4.468-20.217-9.98c0-5.512 9.052-9.98 20.217-9.98zm178.057 34.02c11.165 0 20.216 4.468 20.217 9.98 0 5.512-9.052 9.98-20.217 9.98s-20.217-4.468-20.217-9.98c0-5.512 9.052-9.98 20.217-9.98zm-273.59 21.535c11.165 0 20.216 4.468 20.217 9.98 0 5.513-9.052 9.98-20.217 9.98s-20.217-4.467-20.217-9.98c0-5.512 9.052-9.98 20.217-9.98zm313.77 30.043c11.165 0 20.216 4.468 20.216 9.98 0 5.512-9.051 9.98-20.217 9.98-11.165 0-20.216-4.468-20.216-9.98 0-5.512 9.051-9.98 20.216-9.98zm-137.91 8.045c11.166 0 20.218 4.47 20.216 9.982 0 5.512-9.051 9.98-20.217 9.98-11.165 0-20.216-4.468-20.216-9.98-.002-5.513 9.05-9.982 20.216-9.982zM57.618 212.339c-18.964.405-9.028 24.485 14.383 24.573 128.554 10.208 236.673 9.686 372.117-2.42 16.096-2.708 25.212-13.087 10.824-21.969-131.579 7.67-263.81 10.045-397.324-.184zm403.024 40.612c-131.224 13.6-277.594 10.525-390.065 1.904-46.983-6.226-47.875 46.785-17.014 52.309 146.18 14.663 271.826 10.735 415.137-.53 25.007-1.144 14.554-55.328-8.058-53.683zM20.986 366.679l15.332 9.434c6.342-8.416 17.876-32.05 33.319-32.192 19.122-.174 22.345 39.302 41.98 39.103 22.607-.228 37.828-31.548 52.447-30.882 22.09 1.008 26.333 35.9 43.557 35.928 24.089.04 31.439-36.39 46.805-35.334 21.458 1.475 33.246 28.274 50.879 29.178 19.004.974 30.654-33.027 43.265-32.748 16.61.366 28.31 32.46 54.24 33.193 15.345.434 29.694-37.411 37.005-36.815 14.417 1.174 26.549 20.548 36.085 34.835l15.114-9.776c-12.029-16.216-30.117-44.428-52.558-44.017-20.907.382-25.948 38.114-38.102 37.943-23.28-.328-33.756-32.164-52.598-33.346-19.356-1.214-30.475 33.636-43.353 32.768-18.954-1.277-27.303-29.16-49.475-29.917-19.62-.67-34.121 37.669-46.793 36.044-18.139-2.326-20.226-36.378-43.317-37.836-19.11-1.207-37.562 30.604-50.314 29.999-17.525-.833-25.243-40.224-45.41-39.986-21.826.258-39.145 30.34-48.108 44.424zm47.553 36.174c-8.342.686-18.198 4.251-21.85 12.424-2.452 6.662 19.173 8.558 21.114 8.695 128.615 8.104 254.354 8.26 389.8-1.345 9.225-.655 13.935-3.147 15.252-4.414 3.124-8.208-23.168-13.935-25.818-14.004-185.01-1.178-279.257 2.209-378.498-1.356zm395.555 37.192c-126.786 6.957-283.18 9.384-408.123.707l.521 38.67c135.917 4.617 275.647 3.99 406.658-.088z"></path></svg></button><div class="collapse navbar-collapse"><a class="nav-link" href="/projects/">Projects</a><a class="nav-link active" href="/latest/">Blog</a><div class="navbar-separator"></div><a class="nav-link" href="/about/">About</a></div></nav><div class="root-wrapper expand-height"><div class="text-light large" style="background-color:black;margin:0;padding:15px;padding-left:30px;padding-right:30px"><p style="text-align:center;margin:0"><b>Black Lives Matter.</b> Please consider donating to the<!-- --> <a href="https://www.paypal.me/SLOBailFund">San Luis Obispo, CA Bail Fund</a> <!-- -->or <a href="https://bailfunds.github.io">other bail funds</a> so we can make the world a just and equitable place for all people of all colors.</p></div><div style="background-color:#b3e0e6"><nav class="page-heading_above__2RV0m"></nav><header class="page-heading_header__zwjn1"><h1>An overview of the new Gatsby backend</h1><p>Come on in, there&#x27;s digraphs in here</p></header></div><div class="longform-layout_container__1bKFt container"><div class="row"><div class="longform-layout_content__gfokN col-lg-8"><article class="longform"><article class="longform"><div><p>One of the big parts of the 0.2 release is a thing that no one will ever get to see directly: The brand new, highly modular backend. This post will likely be highly technical, but if anyone wants to see how it all works inside, this is for you.</p>
<h2 id="a-quick-primer-on-gatsby">A quick primer on Gatsby</h2>
<h3 id="static-site-generation">Static Site Generation</h3>
<p>A static site generator is a program that outputs a website that is completely pre-built. It outputs a big bundle of HTML, CSS, and JS plus media and nothing else. Some examples include <a href="https://www.gatsbyjs.org/">Gatsby</a>, which this site is built on, and <a href="https://jekyllrb.com/">Jekyll</a>, which is one of the more popular ones.</p>
<p><strong>What’s the point?</strong> Essentially, the reason you would do this instead of making a dynamic site (one where the server renders HTML every request) is because you can host it anywhere without any server-side logic. All you really need is a barebones Apache or Nginx server, or you can be like me and host it on <a href="https://pages.github.com/">GitHub Pages</a>. Because the HTML isn’t changing unlike on a dynamic website, it’s super duper good for browsers, since the browser can just cache all the data and only need to download things once.</p>
<p><strong>Why would you do this instead of just writing the HTML by hand?</strong> Because writing HTML by hand is repetitive and prone to error, not to mention <em>boring</em>. By using a static site generator, you can do cool things like:</p>
<ul>
<li>Write your blog posts in Markdown!</li>
<li>Write your blog posts as Jupyter notebooks!</li>
<li>Use YAML to describe certain pieces of content!</li>
<li>Programmatically link tags to the correct location so you don’t need to do so much copying and pasting of HTML!</li>
</ul>
<p>All of this, by the way, is stuff that this site does.</p>
<p>My <code>create-react-app</code>-based website from the very beginning <em>really wanted to do this!</em> But I don’t think <code>create-react-app</code> was really designed to make static sites. At one point, I was rendering blog posts like this one in the browser, which is obviously a pretty terrible idea.</p>
<p>Luckily for me, Gatsby exists and it solves all of my problems!</p>
<h3 id="why-gatsby">Why Gatsby?</h3>
<p>Gatsby uses React, so it wasn’t too hard to migrate my old stuff over. Additionally it has a pretty cool content sourcing system.</p>
<ol>
<li>You have source nodes, like files or remote resources or the time that the website was built</li>
<li>…that get transformed into other nodes by transformers (for example, <code>gatsby-transformer-remark</code> takes markdown files and spits out <code>MarkdownRemark</code> nodes)</li>
<li>…and they might get transformed into more nodes (I might take one of those markdown nodes and convert it into a <code>Project</code>)</li>
<li>…and at the very end, you can create pages from nodes or run GraphQL queries on them.</li>
</ol>
<p>When I was first learning it, I was doing a lot of things rather poorly and incorrectly. But after a month of triumphs and mistakes, I’ve learned a lot about the framework, so I was confident enough to rewrite my backend to be better.</p>
<h2 id="the-new-backend">The new backend</h2>
<h3 id="why-it-was-needed">Why it was needed</h3>
<p>Before this refactoring, the backend was spread across a 528-line <code>gatsby-node.js</code> in the root directory and 284 lines of Typescript in <code>src/gatsby</code>. The <code>gatsby-node.js</code> was very hard to maintain, which was why after a certain point I just wrote all new code in Typescript. Even then, I still felt a twinge of pain every time I had to <em>touch</em> anything near the backend.</p>
<p>Now, the code is spread across 1283 lines of Typescript in 10 highly modular plugins. The line count increase is somewhat misleading, due to me having added a few more features and defined the schema of most of the nodes. However, the other reason it’s bigger is because of Typescript, and the fact that I also defined the types of some of my objects.</p>
<p>Additionally, all files except for one are under 200 lines, and they’re all in Typescript, making them much easier to work with for me. Whereas before, my code was in a gigantic monolith, now each plugin has its own well-defined, highly-specific focus. Each typescript file is small enough to be easily digestible by my tiny brain. It was super easy to test individual failing plugins because all I had to do was comment out the plugin declaration in <code>gatsby-config.js</code>.</p>
<h3 id="high-level-architectural-overview">High-level architectural overview</h3>
<p>Within my <code>plugins/</code> directory, there are 10 plugins and 1 util folder for shared code. Here is what each plugin does:</p>
<ul>
<li><code>gatsby-astrid-plugin-blog</code> - Finds blog posts and makes pages for them.</li>
<li><code>gatsby-astrid-plugin-tagging</code> - Responsible for making it easy to query objects for their tags, and tags for their objects.</li>
<li><code>gatsby-astrid-transformer-markdown-post</code> - Converts markdown posts in the blog folder into blog post objects.</li>
<li><code>gatsby-astrid-transformer-notebook-markdown</code> - Converts Jupyter notebooks into Markdown nodes and is responsible for Jupyter notebook posts like <a href="/blog/2020-06-18-frequency-shifting">this one</a>.</li>
<li><code>gatsby-astrid-source-lang-tags</code> - Responsible for making colorful language tags.</li>
<li><code>gatsby-astrid-transformer-user-tags</code> - Responsible for “user tags,” or tags whose names and parameters I manually defined. This is why some tags, like React and Gatsby, have colors correctly corresponding to their branding.</li>
<li><code>gatsby-astrid-transformer-education</code>, <code>gatsby-astrid-transformer-project</code>, <code>gatsby-astrid-transformer-skills</code>, <code>gatsby-astrid-transformer-work</code>, and more to come - The actual content of the site.</li>
</ul>
<p>Here is the graph of all the node type transformations my code does.</p>
<a href="/_/2020/07/26/3dafcfeb3458f45cea14e5b197322504f318999a.svg"><img src="/_/2020/07/26/3dafcfeb3458f45cea14e5b197322504f318999a.svg" title="`dot` image" width="1200"/></a>
<p>It looks pretty complicated, but that’s only because of the sheer quantity of stuff there is. It’s all very wide, but not actually very deep. For example, you may notice some repeated structures here, such as</p>
<a href="/_/2020/07/26/5e6ffc5b1140eb499a0a9d1e27994b5583e6eb42.svg"><img src="/_/2020/07/26/5e6ffc5b1140eb499a0a9d1e27994b5583e6eb42.svg" title="`dot` image" width="1200"/></a>
<p>This type of structure is used to automatically generate tags out of certain pieces of content. In fact, you can see it in action with this blog post, which is linked to <a href="/projects/astrid-tech">the astrid.tech project</a>.</p>
<p>Now, Gatsby doesn’t like it when two plugins define and create the same type. However, to get around this, I create a (<code>ProjectTag</code>) with a special mimetype on it (<code>application/prs.astrid-tech-tag</code>) that the tagging plugin detects. The tagging plugin then uses the data in that node to create an actual tag.</p>
<p>Though it does add some complexity and indirectness, the really nice side effect of this is that I can actually remove some plugins and the site will still work perfectly, as if nothing was changed.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this post, we examined the high-level architecture of the new backend. In future posts, we will take a look at some of the individual plugins, and how they work.</p></div></article></article></div><div class="col-lg-4"><div class="longform-layout_sidebarGroup__1maJR"><table style="width:100%"><tbody><tr><th style="min-width:180px"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm436-44v-36c0-26.5-21.5-48-48-48h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v36c0 6.6 5.4 12 12 12h424c6.6 0 12-5.4 12-12z"></path></svg> <!-- -->Date</th><td class="longform-layout_statusData__1GlEa">26 Jul 2020</td></tr></tbody></table></div><div class="longform-layout_sidebarGroup__1maJR"><h2>Tags</h2><div><p style="font-size:12pt;margin-bottom:3px"><a href="/projects/astrid-tech/"><span style="background-color:#0afbff;color:#000000;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">/projects/astrid-tech/</span></a><a href="/t/gatsby-js"><span style="background-color:#663399;color:#ffffff;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">Gatsby.js</span></a><a href="/t/graphviz"><span style="background-color:#6000d6;color:#ffffff;cursor:pointer" class="tag_tag__1JK8b p-category badge badge-secondary">graphviz</span></a> </p></div></div></div></div></div><div class="container"><section id="comments"><h2>Comments</h2><div class="comments"><div><form class=""><div class="row form-group"><label for="comment-name" class="col-sm-4 col-form-label">Name (leave blank for anonymous)</label><div class="col-sm-8"><input type="text" name="name" id="comment-name" placeholder="Willy Shakespeare" class="form-control"/></div></div><div class="row form-group"><label for="comment-email" class="col-sm-4 col-form-label">Email (required)</label><div class="col-sm-8"><input type="email" name="email" id="comment-email" placeholder="user@example.com" class="form-control"/></div></div><div class="row form-group"><label for="comment-website" class="col-sm-4 col-form-label">Website</label><div class="col-sm-8"><input type="url" name="website" id="comment-website" placeholder="my.cool.site" class="form-control"/></div></div><div class="form-group"><label for="comment-body" class="">Comment (<!-- -->1000<!-- --> chars left)</label><textarea name="body" id="comment-body" placeholder="Type your comment here..." class="form-control"></textarea><small class="form-text text-muted">Markdown formatting is supported.</small></div><div class="row"><button type="button" class="btn btn-primary">Submit!</button></div></form></div></div></section></div></div><footer class="footer_footer__1KZqX"><div class="text-light small container"><div class="col"><nav class="row"><div class="col-6 col-sm-4"><a href="/privacy/">Privacy Policy</a></div><div class="col-6 col-sm-4"><a href="/licenses/">Open Source Licenses</a></div><div class="col-6 col-sm-4"><a href="/about/">About/Contact</a></div></nav></div><div class="col"><p>astrid.tech v<!-- -->2.0.0<!-- --> was created by Astrid Yu with a generous helping of <span title="tea" aria-label="tea" role="img">☕</span> and <span title="witchcraft" aria-label="witchcraft" role="img">🧙‍</span>. See the<!-- --> <a href="/projects/astrid-tech/">self-referential project page</a> <!-- -->or see the code yourself on<!-- --> <a href="https://github.com/astralbijection/astrid.tech">GitHub</a>.</p></div><div class="row"><div class="col"></div></div><div class="row"><div class="text-center col"><a href="https://www.gnu.org/licenses/agpl-3.0.en.html"><img alt="GNU Affero General Public License" width="100" height="40" src="/agpl.png"/></a><p><a href="https://github.com/astralbijection/astrid.tech">The source code of astrid.tech</a> <!-- -->is licensed under the<!-- --> <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">AGPL License</a>.<!-- --> </p></div><div class="text-center col"><p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/></a><br/><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">The page content of astrid.tech</span> <!-- -->by<!-- --> <a xmlns:cc="http://creativecommons.org/ns#" href="https://astrid.tech" property="cc:attributionName" rel="cc:attributionURL">Astrid Yu</a> <!-- -->is licensed under a<!-- --> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":16,"assetRoot":"2020/07/26","thumbnail":null,"title":"An overview of the new Gatsby backend","description":"Come on in, there's digraphs in here","slug":"gatsby-backend","date":"2020-07-26T08:07:00.000Z","content":"\u003cp\u003eOne of the big parts of the 0.2 release is a thing that no one will ever get to see directly: The brand new, highly modular backend. This post will likely be highly technical, but if anyone wants to see how it all works inside, this is for you.\u003c/p\u003e\n\u003ch2 id=\"a-quick-primer-on-gatsby\"\u003eA quick primer on Gatsby\u003c/h2\u003e\n\u003ch3 id=\"static-site-generation\"\u003eStatic Site Generation\u003c/h3\u003e\n\u003cp\u003eA static site generator is a program that outputs a website that is completely pre-built. It outputs a big bundle of HTML, CSS, and JS plus media and nothing else. Some examples include \u003ca href=\"https://www.gatsbyjs.org/\"\u003eGatsby\u003c/a\u003e, which this site is built on, and \u003ca href=\"https://jekyllrb.com/\"\u003eJekyll\u003c/a\u003e, which is one of the more popular ones.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhat’s the point?\u003c/strong\u003e Essentially, the reason you would do this instead of making a dynamic site (one where the server renders HTML every request) is because you can host it anywhere without any server-side logic. All you really need is a barebones Apache or Nginx server, or you can be like me and host it on \u003ca href=\"https://pages.github.com/\"\u003eGitHub Pages\u003c/a\u003e. Because the HTML isn’t changing unlike on a dynamic website, it’s super duper good for browsers, since the browser can just cache all the data and only need to download things once.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy would you do this instead of just writing the HTML by hand?\u003c/strong\u003e Because writing HTML by hand is repetitive and prone to error, not to mention \u003cem\u003eboring\u003c/em\u003e. By using a static site generator, you can do cool things like:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWrite your blog posts in Markdown!\u003c/li\u003e\n\u003cli\u003eWrite your blog posts as Jupyter notebooks!\u003c/li\u003e\n\u003cli\u003eUse YAML to describe certain pieces of content!\u003c/li\u003e\n\u003cli\u003eProgrammatically link tags to the correct location so you don’t need to do so much copying and pasting of HTML!\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAll of this, by the way, is stuff that this site does.\u003c/p\u003e\n\u003cp\u003eMy \u003ccode\u003ecreate-react-app\u003c/code\u003e-based website from the very beginning \u003cem\u003ereally wanted to do this!\u003c/em\u003e But I don’t think \u003ccode\u003ecreate-react-app\u003c/code\u003e was really designed to make static sites. At one point, I was rendering blog posts like this one in the browser, which is obviously a pretty terrible idea.\u003c/p\u003e\n\u003cp\u003eLuckily for me, Gatsby exists and it solves all of my problems!\u003c/p\u003e\n\u003ch3 id=\"why-gatsby\"\u003eWhy Gatsby?\u003c/h3\u003e\n\u003cp\u003eGatsby uses React, so it wasn’t too hard to migrate my old stuff over. Additionally it has a pretty cool content sourcing system.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eYou have source nodes, like files or remote resources or the time that the website was built\u003c/li\u003e\n\u003cli\u003e…that get transformed into other nodes by transformers (for example, \u003ccode\u003egatsby-transformer-remark\u003c/code\u003e takes markdown files and spits out \u003ccode\u003eMarkdownRemark\u003c/code\u003e nodes)\u003c/li\u003e\n\u003cli\u003e…and they might get transformed into more nodes (I might take one of those markdown nodes and convert it into a \u003ccode\u003eProject\u003c/code\u003e)\u003c/li\u003e\n\u003cli\u003e…and at the very end, you can create pages from nodes or run GraphQL queries on them.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eWhen I was first learning it, I was doing a lot of things rather poorly and incorrectly. But after a month of triumphs and mistakes, I’ve learned a lot about the framework, so I was confident enough to rewrite my backend to be better.\u003c/p\u003e\n\u003ch2 id=\"the-new-backend\"\u003eThe new backend\u003c/h2\u003e\n\u003ch3 id=\"why-it-was-needed\"\u003eWhy it was needed\u003c/h3\u003e\n\u003cp\u003eBefore this refactoring, the backend was spread across a 528-line \u003ccode\u003egatsby-node.js\u003c/code\u003e in the root directory and 284 lines of Typescript in \u003ccode\u003esrc/gatsby\u003c/code\u003e. The \u003ccode\u003egatsby-node.js\u003c/code\u003e was very hard to maintain, which was why after a certain point I just wrote all new code in Typescript. Even then, I still felt a twinge of pain every time I had to \u003cem\u003etouch\u003c/em\u003e anything near the backend.\u003c/p\u003e\n\u003cp\u003eNow, the code is spread across 1283 lines of Typescript in 10 highly modular plugins. The line count increase is somewhat misleading, due to me having added a few more features and defined the schema of most of the nodes. However, the other reason it’s bigger is because of Typescript, and the fact that I also defined the types of some of my objects.\u003c/p\u003e\n\u003cp\u003eAdditionally, all files except for one are under 200 lines, and they’re all in Typescript, making them much easier to work with for me. Whereas before, my code was in a gigantic monolith, now each plugin has its own well-defined, highly-specific focus. Each typescript file is small enough to be easily digestible by my tiny brain. It was super easy to test individual failing plugins because all I had to do was comment out the plugin declaration in \u003ccode\u003egatsby-config.js\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"high-level-architectural-overview\"\u003eHigh-level architectural overview\u003c/h3\u003e\n\u003cp\u003eWithin my \u003ccode\u003eplugins/\u003c/code\u003e directory, there are 10 plugins and 1 util folder for shared code. Here is what each plugin does:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003egatsby-astrid-plugin-blog\u003c/code\u003e - Finds blog posts and makes pages for them.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egatsby-astrid-plugin-tagging\u003c/code\u003e - Responsible for making it easy to query objects for their tags, and tags for their objects.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egatsby-astrid-transformer-markdown-post\u003c/code\u003e - Converts markdown posts in the blog folder into blog post objects.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egatsby-astrid-transformer-notebook-markdown\u003c/code\u003e - Converts Jupyter notebooks into Markdown nodes and is responsible for Jupyter notebook posts like \u003ca href=\"/blog/2020-06-18-frequency-shifting\"\u003ethis one\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egatsby-astrid-source-lang-tags\u003c/code\u003e - Responsible for making colorful language tags.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egatsby-astrid-transformer-user-tags\u003c/code\u003e - Responsible for “user tags,” or tags whose names and parameters I manually defined. This is why some tags, like React and Gatsby, have colors correctly corresponding to their branding.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egatsby-astrid-transformer-education\u003c/code\u003e, \u003ccode\u003egatsby-astrid-transformer-project\u003c/code\u003e, \u003ccode\u003egatsby-astrid-transformer-skills\u003c/code\u003e, \u003ccode\u003egatsby-astrid-transformer-work\u003c/code\u003e, and more to come - The actual content of the site.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere is the graph of all the node type transformations my code does.\u003c/p\u003e\n\u003cimg src=\"/_/2020/07/26/3dafcfeb3458f45cea14e5b197322504f318999a.svg\" title=\"\u0026#x60;dot\u0026#x60; image\"\u003e\n\u003cp\u003eIt looks pretty complicated, but that’s only because of the sheer quantity of stuff there is. It’s all very wide, but not actually very deep. For example, you may notice some repeated structures here, such as\u003c/p\u003e\n\u003cimg src=\"/_/2020/07/26/5e6ffc5b1140eb499a0a9d1e27994b5583e6eb42.svg\" title=\"\u0026#x60;dot\u0026#x60; image\"\u003e\n\u003cp\u003eThis type of structure is used to automatically generate tags out of certain pieces of content. In fact, you can see it in action with this blog post, which is linked to \u003ca href=\"/projects/astrid-tech\"\u003ethe astrid.tech project\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eNow, Gatsby doesn’t like it when two plugins define and create the same type. However, to get around this, I create a (\u003ccode\u003eProjectTag\u003c/code\u003e) with a special mimetype on it (\u003ccode\u003eapplication/prs.astrid-tech-tag\u003c/code\u003e) that the tagging plugin detects. The tagging plugin then uses the data in that node to create an actual tag.\u003c/p\u003e\n\u003cp\u003eThough it does add some complexity and indirectness, the really nice side effect of this is that I can actually remove some plugins and the site will still work perfectly, as if nothing was changed.\u003c/p\u003e\n\u003ch2 id=\"conclusion\"\u003eConclusion\u003c/h2\u003e\n\u003cp\u003eIn this post, we examined the high-level architecture of the new backend. In future posts, we will take a look at some of the individual plugins, and how they work.\u003c/p\u003e","tags":["/projects/astrid-tech/","gatsby-js","graphviz"]}},"__N_SSG":true},"page":"/[year]/[month]/[day]/[...slug]","query":{"year":"2020","month":"07","day":"26","slug":["gatsby-backend"]},"buildId":"xu5MpDjzYRyNj4te1Gtrv","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>